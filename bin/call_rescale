#!/usr/bin/env python

import nibabel as nb
import sys
import os
from lazyfmri import utils

def main(argv):

    """
---------------------------------------------------------------------------------------------------
call_rescale

This script is a wrapper for ANTs' ImageMath to rescale the intensity range of a given input
image by the given min/max intensity range. If output is left empty, the input image will be
overwritten

Arguments:
    input image (str)   image to be rescaled
    lower border (int)  value of new lower border
    upper border (int)  value of new upper border

Optional:
    output image (str)  output image; optional > default is to overwrite input image

Outputs
    rescaled image

Example:
    call_rescale t1w_image.nii.gz 0 4095
    call_rescale t1w_image.nii.gz 0 4095 t1w_rescaled.nii.gz

---------------------------------------------------------------------------------------------------
    """

    if len(argv) < 3:
        print(main.__doc__)
        sys.exit(1)

    input_image, min_range, max_range = argv[:3]
    output = argv[3] if len(argv) > 3 else input_image

    img = nb.load(input_image)
    dim = img.header["dim"][0]
    cmd_txt = f"ImageMath {dim} {output} RescaleImage {input_image} {min_range} {max_range}"
    utils.run_shell_wrapper(cmd_txt)

    # set code
    utils.run_shell_wrapper(f"call_copyheader {input_image} {out}")

if __name__ == "__main__":
    main(sys.argv[1:])
