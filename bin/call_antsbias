#!/usr/bin/env bash

#---------------------------------------------------------------------------------------------------
# call_antsbias - Wrapper for ANTs N4BiasFieldCorrection with flexible options passthrough
#---------------------------------------------------------------------------------------------------

function Usage {
    cat <<USAGE

---------------------------------------------------------------------------------------------------
call_antsbias

Wrapper for bias field correction with ANTs' N4-function. Takes an input file and an output file
using default setting for 'N4BiasFieldCorrection'. You can add more flags directly to the function
after specifying the input and output files.

This script allows specifying:
- Required input file
- Required output file
- Common options like shrink factor and convergence
- Any additional options from N4BiasFieldCorrection, passed as extra arguments (kwargs).

Usage:
  call_antsbias [default_options] <input file> <output file> [extra_options]

Options:
  -o                     Overwrite existing output file
  -s shrink              Set shrink factor (default: 1 -> keep native resolution)
  -c convergence         Set convergence (default: 50x50x50x50)
  --verbose              Make some noise
  [extra_options]        anything after gets passed to N4BiasFieldCorrection

Example:
  call_antsbias -s 4 input.nii.gz output.nii.gz -x mask.nii.gz -r 1

Notes:
see https://github.com/ANTsX/ANTs/wiki/N4BiasFieldCorrection for more information on the relation-
ship between parameters (especially spline spacing & convergence)

---------------------------------------------------------------------------------------------------

USAGE
    exit 1
}

#---------------------------------------------------------------------------------------------------
# Defaults
ow=0
shrink=1
convergence="50x50x50x50"
threshold="1e-10"
verbose=0

#---------------------------------------------------------------------------------------------------
# Parse options
while getopts "vos:c:" opt; do
  case $opt in
    o) ow=1 ;;
    s) shrink="$OPTARG" ;;
    c) convergence="$OPTARG" ;;
    v) verbose=1 ;;
    *) Usage ;;
  esac
done
shift $((OPTIND-1))

#---------------------------------------------------------------------------------------------------
# Required arguments
if [[ $# -lt 1 ]]; then
  Usage
fi

input="$(readlink -f "$1" 2>/dev/null || realpath "$1")"
output="$(readlink -f "${2:-}" 2>/dev/null || realpath "${2:-}")"

shift 2 || true  # Shift away input & output arguments if present

# Capture any additional arguments passed after "--"
extra_args=()
while [[ $# -gt 0 ]]; do
  extra_args+=("$1")
  shift
done

#---------------------------------------------------------------------------------------------------
# Run N4BiasFieldCorrection
if [[ ! -f "$input" ]]; then
  echo "Error: Input file does not exist: $input" >&2
  exit 1
fi

if [[ -z "$output" ]]; then
  echo "Error: please specify output file" >&2
  exit 1
fi

if [[ -f "$output" && $ow -ne 1 ]]; then
  echo "Error: Output file already exists and -o (overwrite) was not specified: $output" >&2
  exit 1
fi

dim=$(fslval "$input" dim0)
if [[ -z "$dim" ]]; then
  echo "Error: Unable to determine image dimensionality with fslval." >&2
  exit 1
fi

echo "Running N4BiasFieldCorrection:"
echo "  Input          = $(basename "$input")"
echo "  Dimensionality = $dim"
echo "  Shrink factor  = $shrink"
echo "  Convergence    = [$convergence,$threshold]"
echo "  Output         = $(basename "$output")"
echo "  Extra options  = ${extra_args[*]:-(none)}"
echo

cmd=(
  N4BiasFieldCorrection
  --image-dimensionality "$dim"
  --input-image "$input"
  --shrink-factor "$shrink"
  --convergence "[$convergence,$threshold]"
  --output "$output"
  --verbose ${verbose}
  "${extra_args[@]}"
)

echo "Executing: ${cmd[*]}"
"${cmd[@]}"

if [[ $? -ne 0 ]]; then
  echo "Error: N4BiasFieldCorrection failed." >&2
  exit 1
fi

echo "Bias field correction complete."
