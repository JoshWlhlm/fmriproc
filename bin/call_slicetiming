#!/usr/bin/env python

import argparse
from fmriproc import image


def main():
    parser = argparse.ArgumentParser(
        description="Add SliceTiming field to a BIDS-sidecar JSON or load from file."
    )
    parser.add_argument(
        '--json', '-j',
        required=True,
        help='Path to existing JSON file.'
    )
    parser.add_argument(
        '--tr', '-t',
        type=float,
        help='Repetition time (TR) in seconds.'
    )
    parser.add_argument(
        '--slices', '-s',
        type=int,
        help='Total number of slices.'
    )
    parser.add_argument(
        '--mb', '-m',
        type=int,
        default=1,
        help='Multi-band factor (default=1).'
    )
    parser.add_argument(
        '--order', '-o',
        choices=['ascending', 'descending'],
        default='ascending',
        help="Slice acquisition order (ascending/descending)."
    )
    parser.add_argument(
        '--interleaved', '-i',
        action='store_true',
        help='Use interleaved ordering (based on sqrt step size).'
    )
    parser.add_argument(
        '--file', '-f',
        help='Path to text file with precomputed slice timings.'
    )

    args = parser.parse_args()

    # Ensure either computation params or file are provided
    if not args.file and (args.tr is None or args.slices is None):
        parser.error('Either --file or both --tr and --slices must be specified.')

    image.slice_timings_to_json(
        args.json,
        nr_slices=args.slices,
        tr=args.tr,
        mb_factor=args.mb,
        order=args.order,
        interleaved=args.interleaved,
        file=args.file
    )


if __name__ == '__main__':
    main()
