

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fmriproc.prf &mdash; fMRIproc Documentation 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fMRIproc Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview of fMRIproc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline_steps.html">Pipeline Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../additional_software.html">Required External Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_usage.html">Running fMRIproc on HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting &amp; Common Issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../classes/index.html">Python modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bash.html">Bash modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fMRIproc Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fmriproc.prf</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fmriproc.prf</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">fmriproc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lazyfmri</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">utils</span><span class="p">,</span> 
    <span class="n">plotting</span><span class="p">,</span> 
    <span class="n">dataset</span><span class="p">,</span> 
    <span class="n">fitting</span><span class="p">,</span>
    <span class="n">preproc</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpimg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">past.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">old_div</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">rf</span><span class="p">,</span> <span class="n">stimulus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy.fit</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prfpy.model</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">signal</span><span class="p">,</span>
    <span class="n">io</span><span class="p">,</span>
    <span class="n">interpolate</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="n">opj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

<div class="viewcode-block" id="resample2d">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.resample2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resample2d</span><span class="p">(</span><span class="n">array</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">new_size</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;resample2d</span>

<span class="sd">    Resamples a 2D (or 3D) array with :func:`scipy.interpolate.interp2d` to `new_size`. If input is 2D, we&#39;ll loop over the final axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array: np.ndarray</span>
<span class="sd">        Array to be interpolated. Ideally axis have the same size.</span>
<span class="sd">    new_size: int</span>
<span class="sd">        New size of array</span>
<span class="sd">    kind: str, optional</span>
<span class="sd">        Interpolation method, by default &#39;linear&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        If 2D: resampled array of shape `(new_size,new_size)`</span>
<span class="sd">        If 3D: resampled array of shape `(new_size,new_size, array.shape[-1])`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up interpolater</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># define new grid</span>
    <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_size</span><span class="p">)</span>
    <span class="n">ynew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">new_size</span><span class="p">,</span><span class="n">new_size</span><span class="p">,</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">dd</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">new</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">ynew</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">ynew</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="normalize_prf">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.normalize_prf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_prf</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">targ</span><span class="p">):</span>

    <span class="c1"># check that we have enough parameters</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">par</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">src</span><span class="p">,</span><span class="n">targ</span><span class="p">],[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="s2">&quot;target&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;need at least three parameters (x,y,sigma) for &#39;</span><span class="si">{</span><span class="n">par</span><span class="si">}</span><span class="s2">&#39; pRF, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># get overlap prior to normalization</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">distance_centers</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">targ</span><span class="p">)</span><span class="o">/</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="c1"># normalize</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">targ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">norm</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># get new distance</span>
    <span class="n">x_prime</span> <span class="o">=</span> <span class="n">distance_centers</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm</span><span class="p">)</span>

    <span class="c1"># shift position so that distances are the same again</span>
    <span class="n">p_prime</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]):</span>
        <span class="n">corrected_position</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">/</span><span class="n">x_prime</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">p_prime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corrected_position</span><span class="p">)</span>

    <span class="c1"># p_prime only has position, add size back to it</span>
    <span class="n">p_prime</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">p_prime</span></div>

    
<div class="viewcode-block" id="read_par_file">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.read_par_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_par_file</span><span class="p">(</span><span class="n">prf_file</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;pars&quot;</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;read_par_file</span>

<span class="sd">    Function to read in files containing pRF-estimates from various sources. Currently, supports the following inputs:</span>
<span class="sd">    `np.ndarray`, `npy`-file, `mat`-file (will read in the data from the last item in `list(prf_file.keys())`), `pkl`-file</span>
<span class="sd">    (assumes has key &#39;pars&#39; in it). Because we generally save the design matrix as a *.mat*-file, we can use the same function</span>
<span class="sd">    to read in that file and obtain the design matrix in `np.ndarray`-format. Inputs `pd.DataFrame` will be converted to</span>
<span class="sd">    `np.ndarray` with :func:`fmriproc.prf.Parameters`, assuming certain column names to be present.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        array containing the pRF-estimates or other parameters (e.g., design matrix embedded in `mat`-file)</span>

<span class="sd">    Raises</span>
<span class="sd">    ----------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If `pkl`-file was given, but attribute `pars` does not exist inside the file</span>
<span class="sd">    TypeError</span>
<span class="sd">        If the input is not a `np.ndarray`, and not a string ending on `npy`, `mat`, or `pkl`</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        # read in pRF-estimates file</span>
<span class="sd">        from fmriproc import prf</span>
<span class="sd">        prf_file = &quot;sub-01_ses-1_task-2R_model-norm_stage-iter_desc-prf_params.pkl&quot;</span>
<span class="sd">        pars = prf.read_par_file(prf_file)</span>

<span class="sd">        # read design matrix</span>
<span class="sd">        from fmriproc import prf</span>
<span class="sd">        dm_file = &quot;design_task-2R.mat&quot;</span>
<span class="sd">        dm = prf.read_par_file(dm_file)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prf_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prf_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prf_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;npy&quot;</span><span class="p">):</span>
                <span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">prf_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prf_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mat&quot;</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">prf_file</span><span class="p">)</span>
                <span class="n">pars</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># find last key in list</span>
            <span class="k">elif</span> <span class="n">prf_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;pkl&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prf_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pars</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Pickle-file did not arise from &#39;pRFmodelFitting&#39;. I&#39;m looking for &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;, but got</span>
<span class="s2">                                        &#39;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input &#39;</span><span class="si">{</span><span class="n">prf_file</span><span class="si">}</span><span class="s2">&#39; is not a file..&quot;</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prf_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">prf_file</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prf_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="n">prf_file</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown input file &#39;</span><span class="si">{</span><span class="n">prf_file</span><span class="si">}</span><span class="s2">&#39;. Must be one of [&#39;str&#39;, &#39;npy&#39;, &#39;pkl&#39;] or a numpy.ndarray&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pars</span></div>

     
<div class="viewcode-block" id="get_prfdesign">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.get_prfdesign">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_prfdesign</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="n">n_pix</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">dm_edges_clipping</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_prfdesign</span>

<span class="sd">    Basically Marco&#39;s gist, but then incorporated in the repo. It takes the directory of screenshots and creates a</span>
<span class="sd">    vis_design.mat file, telling pRFpy at what point are certain stimulus was presented.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    screenshot_path: str</span>
<span class="sd">        string describing the path to the directory with png-files</span>
<span class="sd">    n_pix: int</span>
<span class="sd">        size of the design matrix (basically resolution). The larger the number, the more demanding for the CPU. It&#39;s best to</span>
<span class="sd">        have some value which can be divided with 1080, as this is easier to downsample. Default is 40, but 100 seems to be a</span>
<span class="sd">        good trade-off between resolution and CPU-demands</span>
<span class="sd">    dm_edges_clipping: list, dict, optional</span>
<span class="sd">        people don&#39;t always see the entirety of the screen so it&#39;s important to check what the subject can actually see by</span>
<span class="sd">        showing them the cross of for instance the BOLD-screen (the matlab one, not the linux one) and clip the image</span>
<span class="sd">        accordingly. This is a list of 4 values, which are the number of pixels to clip from the left, right, top and bottom</span>
<span class="sd">        of the image. Default is [0,0,0,0], which means no clipping. Negative values will be set to 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        array with shape &lt;n_pix,n_pix,timepoints&gt; representing a binary paradigm</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">        dm = get_prfdesign(</span>
<span class="sd">            &#39;path/to/dir/with/pngs&#39;,</span>
<span class="sd">            n_pix=270,</span>
<span class="sd">            dm_edges_clipping=[6,1,0,1]</span>
<span class="sd">        )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">image_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">)</span>

    <span class="c1"># get first image to get screen size</span>
    <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="n">image_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="c1"># there is one more MR image than screenshot</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">:</span>
        
        <span class="c1"># assuming last three numbers before .png are the screenshot number</span>
        <span class="n">img_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_file</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># subtract one to start from zero</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        
        <span class="c1"># make it square</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:(</span><span class="n">offset</span><span class="o">+</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># binarize image into dm matrix</span>
        <span class="c1"># assumes: standard RGB255 format; only colors present in image are black, white, grey, red, green.</span>
        <span class="n">design_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">img_number</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">design_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">img_number</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#clipping edges; top, bottom, left, right</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dm_edges_clipping</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">dm_edges_clipping</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]]</span>

    <span class="c1"># ensure absolute values; should be a list by now anyway</span>
    <span class="n">dm_edges_clipping</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ele</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">dm_edges_clipping</span><span class="p">]</span>

    <span class="n">design_matrix</span><span class="p">[:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">design_matrix</span><span class="p">[(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">3</span><span class="p">]):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># downsample (resample2d can also deal with 3D input)</span>
    <span class="k">if</span> <span class="n">n_pix</span> <span class="o">!=</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">dm_resampled</span> <span class="o">=</span> <span class="n">resample2d</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">)</span>
        <span class="n">dm_resampled</span><span class="p">[</span><span class="n">dm_resampled</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">dm_resampled</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">design_matrix</span></div>



<div class="viewcode-block" id="radius">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.radius">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">radius</span><span class="p">(</span><span class="n">stim_arr</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;radius</span>

<span class="sd">    Return the radius of a given stimulus within a stimulus grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stim_arr: numpy.ndarray</span>
<span class="sd">        arrays containing the stimulus as created with :func:`fmriproc.prf.make_stims`</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    float</span>
<span class="sd">        radius of circular stimulus within stim_arr</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_idc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stim_arr</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lb</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">max_idc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_idc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">rb</span><span class="o">-</span><span class="n">lb</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">radius</span></div>



<div class="viewcode-block" id="create_circular_mask">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.create_circular_mask">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_circular_mask</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;create_circular_mask</span>

<span class="sd">    Creates a circular mask in a numpy meshgrid to create filled stimuli or mask out parts of a circular stimulus to create</span>
<span class="sd">    concentric stimuli.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h: int</span>
<span class="sd">        height of meshgrid</span>
<span class="sd">    w: int</span>
<span class="sd">        width of meshgrid</span>
<span class="sd">    center: tuple, list</span>
<span class="sd">        center of the circle to create</span>
<span class="sd">    radius: float</span>
<span class="sd">        radius of stimulus to draw</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        np.meshgrid with input size with the specified circle set to ones</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># use the middle of the image</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># use the smallest distance between the center and image walls</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="n">dist_from_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">dist_from_center</span> <span class="o">&lt;=</span> <span class="n">radius</span>
    <span class="k">return</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="make_stims">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.make_stims">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_stims</span><span class="p">(</span>
    <span class="n">xy</span><span class="p">,</span> 
    <span class="n">dim_stim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
    <span class="n">factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
    <span class="n">concentric_size</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> 
    <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">dt</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a list of stimuli to generate size/response curves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array</span>
<span class="sd">        Visual field delineation.</span>
<span class="sd">    prf_object : prfpy.stimulus.PRFStimulus2D</span>
<span class="sd">        Representation of the pRF in visual space.</span>
<span class="sd">    dim_stim : int</span>
<span class="sd">        Number of dimensions to use: 2 for circle, 1 for bar.</span>
<span class="sd">    factor : int</span>
<span class="sd">        Factor by which to increase stimulus size.</span>
<span class="sd">    loc : tuple, optional</span>
<span class="sd">        Location to center stimuli on. Default is (0,0).</span>
<span class="sd">    dt : str, optional</span>
<span class="sd">        Type of stimulus to create. Default is &#39;fill&#39;. Other options:</span>
<span class="sd">        - &#39;full&#39; : fullscreen stimulus</span>
<span class="sd">        - &#39;concentric&#39; : circles with holes</span>
<span class="sd">        - &#39;hole&#39; : fullscreen with growing hole.</span>
<span class="sd">    concentric_size : float, optional</span>
<span class="sd">        Proportion of stimulus size that needs to be masked out again.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of numpy.ndarray</span>
<span class="sd">        List of arrays with meshgrid-size containing the stimuli.</span>
<span class="sd">        Can be plotted with :func:`fmriproc.prf.plot_stims`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">xy</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">factor</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">factor</span><span class="p">)))]</span>
        <span class="n">stim_sizes</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">dt</span> <span class="o">!=</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stims</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#2d rectangle or 1d</span>
                <span class="n">stim</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">pp</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#2d circle</span>
                <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">stim</span><span class="p">[(((</span><span class="n">xx</span><span class="o">-</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">&lt;</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">pp</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">stim_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="n">pp</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span><span class="p">)))</span>

                <span class="c1"># make concentric rings</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="o">==</span> <span class="s2">&quot;concentric&quot;</span><span class="p">:</span>
                    <span class="n">stim_rad</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">stim_rad</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">create_circular_mask</span><span class="p">(</span><span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="o">=</span><span class="n">concentric_size</span><span class="o">*</span><span class="n">stim_rad</span><span class="p">)</span>
                        <span class="n">stim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">dt</span> <span class="o">==</span> <span class="s2">&quot;hole&quot;</span><span class="p">:</span>
            <span class="n">stims_hole</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stims</span><span class="p">:</span>
                <span class="n">stim_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
                <span class="n">stim_inv</span><span class="p">[</span><span class="n">stim</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stims_hole</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_inv</span><span class="p">)</span>

            <span class="n">stims</span> <span class="o">=</span> <span class="n">stims_hole</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
        <span class="n">stim_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ii</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">stims</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">stim_sizes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stims</span></div>


<div class="viewcode-block" id="make_stims2">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.make_stims2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_stims2</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">prf_object</span><span class="p">,</span> <span class="n">dim_stim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">concentric_size</span><span class="o">=</span><span class="mf">0.65</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;make_stims2</span>

<span class="sd">    Creates a list of stimuli to create size/response curves. In contrast to the first version, this version uses</span>
<span class="sd">    :func:`fmriproc.prf.create_circular_mask` more intensively. This allows for the manual specification of visual degrees to</span>
<span class="sd">    use, as it uses an adaptation of psychopy&#39;s `deg2pix` function to translate the visual degree to pixel space to create a</span>
<span class="sd">    numpy mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_pix: int</span>
<span class="sd">        number of pixels in the grid to use</span>
<span class="sd">    prf_object: prfpy.stimulus.PRFStimulus2D</span>
<span class="sd">        representation the pRF in visual space</span>
<span class="sd">    dim_stim: int</span>
<span class="sd">        number of dimensions to use: 2 for circle, 1 for bar</span>
<span class="sd">    degrees: list</span>
<span class="sd">        list representing the range of visual degrees to create the stimuli with</span>
<span class="sd">    concentric: boolean</span>
<span class="sd">        If true, concentric stimuli will be made. For that, the next argument is required</span>
<span class="sd">    concentric_size: float</span>
<span class="sd">        proportion of stimulus size that needs to be masked out again</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    list</span>
<span class="sd">        list of numpy.ndarrays with meshgrid-size containing the stimuli. Can be plotted with :func:`fmriproc.prf.plot_stims`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">degrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">degrees</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">n_pix</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_pix</span><span class="o">/</span><span class="mi">4</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factr</span><span class="o">=</span><span class="mi">4</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_pix</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">factr</span><span class="p">)))]</span>
        <span class="n">stim_sizes</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stims</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#2d rectangle or 1d</span>
            <span class="n">stim</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">pp</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#2d circle</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">create_circular_mask</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">deg2pix</span><span class="p">(</span><span class="n">degrees</span><span class="p">[</span><span class="n">pp</span><span class="p">],</span> <span class="n">prf_object</span><span class="p">))</span>
            <span class="n">stim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># make concentric rings</span>
            <span class="k">if</span> <span class="n">concentric</span><span class="p">:</span>
                <span class="n">stim_rad</span> <span class="o">=</span> <span class="n">radius</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">stim_rad</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">create_circular_mask</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">concentric_size</span><span class="o">*</span><span class="n">stim_rad</span><span class="p">)</span>
                    <span class="n">stim</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">dim_stim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stims</span><span class="p">,</span> <span class="n">degrees</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stims</span></div>



<div class="viewcode-block" id="plot_stims">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.plot_stims">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_stims</span><span class="p">(</span>
    <span class="n">stims</span><span class="p">,</span> 
    <span class="n">n_cols</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">extent</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]),</span>
    <span class="n">save_as</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axis_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">prf_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">as_circle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">prf_color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">add_fixation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">flipud</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">stim_color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;plot_stims</span>

<span class="sd">    Plots all stimuli contained in `stims` as created in `prf.make_stims`. Assumesthat about 33 stimuli have been produced,</span>
<span class="sd">    otherwise axes ordering will be messy..</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stims: list</span>
<span class="sd">        list of numpy.ndarrays with meshgrid-size containing the stimuli</span>
<span class="sd">    n_cols: int, optional</span>
<span class="sd">        number of columns to use. Number of rows will be automatically derived from the number of `stims` and `interval`</span>
<span class="sd">    figsize: tuple, optional</span>
<span class="sd">        custom figure size; otherwise will be determined from the number of columns and rows</span>
<span class="sd">    save_as: str, optional </span>
<span class="sd">        save the figure</span>
<span class="sd">    axis_on: bool, optional</span>
<span class="sd">        show the axes in the figures. Default is false</span>
<span class="sd">    prf_object: np.ndarray, optional</span>
<span class="sd">        add a spatial representation of a pRF to the figure</span>
<span class="sd">    as_circle: bool, optional</span>
<span class="sd">        plot `prf_object` as a simple circle rather than full on pRF-object. The outline of the circle will denote the size of</span>
<span class="sd">        the pRF as per `prfpy`&#39;s convention</span>
<span class="sd">    prf_color: str, optional</span>
<span class="sd">        color of `prf_object`. If `as_circle==True`, the outline will have this color. If not, a binary colormap will be</span>
<span class="sd">        created using :func:`lazyfmri.utils.make_binary_cm()`</span>
<span class="sd">    interval: int, optional</span>
<span class="sd">        show the stimuli with a certain interval. This prevents a mega-amount of figures that needs to be created.</span>
<span class="sd">    stim_color: str, optional</span>
<span class="sd">        color of `stims`. Binary colormap will be created using :func:`lazyfmri.utils.make_binary_cm()`. If false, colormap</span>
<span class="sd">        will be `viridis`</span>
<span class="sd">    add_fixation: bool, optional</span>
<span class="sd">        add fixation cross add (0,0). If `stim_color` is specified, the color will be black; with viridis, the cross will be</span>
<span class="sd">        white</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    matplotlib.pyplot plot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get number of plots</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">stims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># calculate nr of rows based on nr of elements (account for interval-flag)</span>
    <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n_elements</span><span class="o">/</span><span class="n">interval</span><span class="p">))</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">n_elements</span><span class="o">/</span><span class="n">n_cols</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="n">n_rows</span><span class="o">*</span><span class="n">scalar</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">n_rows</span><span class="p">,</span> 
        <span class="n">n_cols</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
        <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prf_object</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">add_prf</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">add_prf</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim_color</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">stim_cm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_binary_cm</span><span class="p">(</span><span class="n">stim_color</span><span class="p">)</span>
        <span class="n">cross_hair_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stim_cm</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span>
        <span class="n">cross_hair_color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># decide input type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">start</span><span class="p">]</span>
            
            <span class="c1"># decide if we need to flip; actual screenshot do no have to be flipped</span>
            <span class="k">if</span> <span class="n">flipud</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># plot</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">stim_cm</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">add_fixation</span><span class="p">:</span>
                <span class="c1"># line on x-axis</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> 
                    <span class="n">color</span><span class="o">=</span><span class="n">cross_hair_color</span><span class="p">,</span> 
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> 
                    <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># line on y-axis</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> 
                    <span class="n">color</span><span class="o">=</span><span class="n">cross_hair_color</span><span class="p">,</span> 
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> 
                    <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_prf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">as_circle</span><span class="p">:</span>
                    <span class="n">prf_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">prf_object</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prf_object</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">prf_object</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">ec</span><span class="o">=</span><span class="n">prf_color</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">prf_</span><span class="p">)</span> 

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_binary_cm</span><span class="p">(</span><span class="n">prf_color</span><span class="p">)</span>
                    <span class="n">prf_</span> <span class="o">=</span> <span class="n">make_prf</span><span class="p">(</span><span class="n">prf_object</span><span class="p">)</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">LazyPRF</span><span class="p">(</span>
                        <span class="n">prf_</span><span class="p">,</span> 
                        <span class="n">extent</span><span class="p">,</span>
                        <span class="n">axs</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span>
                        <span class="n">cross_color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                        <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">shrink_factor</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                        <span class="n">vf_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_on</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">start</span> <span class="o">+=</span> <span class="n">interval</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

    <span class="c1"># return fig</span>

<div class="viewcode-block" id="make_prf">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.make_prf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_prf</span><span class="p">(</span>
    <span class="n">prf_object</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span>
    <span class="n">resize_pix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;make_prf</span>

<span class="sd">    Create an instantiation of a pRF using the parameters obtained during fitting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prf_object: prfpy.stimulus.PRFStimulus2D</span>
<span class="sd">        representation the pRF in visual space</span>
<span class="sd">    mu_x: float</span>
<span class="sd">        x-component of pRF. Leave default if you want to create size/response functions</span>
<span class="sd">    mu_y: float</span>
<span class="sd">        y-component of pRF. Leave default if you want to create size/response functions</span>
<span class="sd">    size: float</span>
<span class="sd">        size of pRF, optional</span>
<span class="sd">    resize_pix: int</span>
<span class="sd">        resolution of pRF to resample to. For instance, if you&#39;ve used a low-resolution design matrix, but you&#39;d like a</span>
<span class="sd">        prettier image, you can set `resize` to something higher than the original (54 &gt;&gt; 270, for example). By default not</span>
<span class="sd">        used.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        meshgrid containing Gaussian characteristics of the pRF. Can be plotted with :func:`lazyfmri.plotting.LazyPRF`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># prf = np.rot90(rf.gauss2D_iso_cart(</span>
    <span class="c1">#     x=prf_object.x_coordinates[..., np.newaxis],</span>
    <span class="c1">#     y=prf_object.y_coordinates[..., np.newaxis],</span>
    <span class="c1">#     mu=(params[0], params[1]),</span>
    <span class="c1">#     sigma=params[2],</span>
    <span class="c1">#     normalize_RFs=False).T, axes=(1, 2))</span>

    <span class="n">prf</span> <span class="o">=</span> <span class="n">create_model_rf_wrapper</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">prf_object</span><span class="p">,</span>
        <span class="n">params</span><span class="p">)</span>

    <span class="c1"># spatially smooth for visualization</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resize_pix</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">prf_squeezed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">prf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">prf</span> <span class="o">=</span> <span class="n">resample2d</span><span class="p">(</span><span class="n">prf_squeezed</span><span class="p">,</span> <span class="n">resize_pix</span><span class="p">)</span>
    
    <span class="c1"># save a bunch of problems if returned array is 2D</span>
    <span class="k">if</span> <span class="n">prf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">prf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">prf</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">prf</span></div>



<span class="c1"># From Marco&#39;s https://github.com/VU-Cog-Sci/prfpytools/blob/master/prfpytools/postproc_utils.py</span>
<div class="viewcode-block" id="norm_2d_sr_function">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.norm_2d_sr_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">norm_2d_sr_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">s_1</span><span class="p">,</span><span class="n">s_2</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">stims</span><span class="p">,</span><span class="n">mu_x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">mu_y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;create size/response function given set of parameters and stimuli&quot;&quot;&quot;</span>

    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">n_stims</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">n_stims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stimuli must be a list or np.ndarray, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">sr_function</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">mu_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">mu_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s_1</span><span class="o">**</span><span class="mi">2</span><span class="p">))[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">n_stims</span><span class="p">)</span><span class="o">*</span><span class="n">stims</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span><span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">/</span>\
    <span class="p">((</span><span class="n">c</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">xx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">mu_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">mu_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s_2</span><span class="o">**</span><span class="mi">2</span><span class="p">))[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">n_stims</span><span class="p">)</span><span class="o">*</span><span class="n">stims</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">d</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>    
    
    <span class="k">return</span> <span class="n">sr_function</span></div>


<span class="c1"># from https://github.com/mdaghlian/MD_toy_dn_scotoma/blob/2d0c208307536fd1853a6befdc38be7fe0d969fb/dn_scripts/RF.py</span>
<div class="viewcode-block" id="gauss_1d_function">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.gauss_1d_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gauss_1d_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create 1d gaussian from parameters&quot;&quot;&quot;</span>
    <span class="n">gauss1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    
    <span class="k">return</span> <span class="n">gauss1d</span></div>


<span class="c1"># From Marco&#39;s https://github.com/VU-Cog-Sci/prfpytools/blob/master/prfpytools/postproc_utils.py</span>
<div class="viewcode-block" id="norm_1d_sr_function">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.norm_1d_sr_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">norm_1d_sr_function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">s_1</span><span class="p">,</span><span class="n">s_2</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">stims</span><span class="p">,</span><span class="n">mu_x</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create size/response function for 1D stimuli&quot;&quot;&quot;</span>

    <span class="n">sr_function</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mu_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s_1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">stims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mu_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">s_2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">stims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">/</span><span class="n">d</span>
    <span class="k">return</span> <span class="n">sr_function</span></div>



<span class="c1"># Adapted from psychopy</span>
<div class="viewcode-block" id="pix2deg">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pix2deg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pix2deg</span><span class="p">(</span>
    <span class="n">pixels</span><span class="p">,</span> 
    <span class="n">prf_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">scrSizePix</span><span class="o">=</span><span class="p">[</span><span class="mi">270</span><span class="p">,</span> <span class="mi">270</span><span class="p">],</span>
    <span class="n">scrWidthCm</span><span class="o">=</span><span class="mf">39.3</span><span class="p">,</span>
    <span class="n">scrDist</span><span class="o">=</span><span class="mi">196</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert size in pixels to size in degrees for a given Monitor object&quot;&quot;&quot;</span> 

    <span class="c1"># get monitor params and raise error if necess</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scrWidthCm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scrDist</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
        <span class="n">scrWidthCm</span> <span class="o">=</span> <span class="n">prf_object</span><span class="o">.</span><span class="n">screen_size_cm</span>
        <span class="n">scrDist</span> <span class="o">=</span> <span class="n">prf_object</span><span class="o">.</span><span class="n">screen_distance_cm</span>

    <span class="n">cmSize</span> <span class="o">=</span> <span class="n">pixels</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">scrWidthCm</span><span class="p">)</span> <span class="o">/</span> <span class="n">scrSizePix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">old_div</span><span class="p">(</span><span class="n">cmSize</span><span class="p">,</span> <span class="p">(</span><span class="n">scrDist</span> <span class="o">*</span> <span class="mf">0.017455</span><span class="p">))</span></div>



<span class="c1"># Adapted from psychopy</span>
<div class="viewcode-block" id="deg2pix">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.deg2pix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">deg2pix</span><span class="p">(</span>
    <span class="n">degrees</span><span class="p">,</span> 
    <span class="n">prf_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">scrSizePix</span><span class="o">=</span><span class="p">[</span><span class="mi">270</span><span class="p">,</span> <span class="mi">270</span><span class="p">],</span>
    <span class="n">scrWidthCm</span><span class="o">=</span><span class="mf">39.3</span><span class="p">,</span>
    <span class="n">scrDist</span><span class="o">=</span><span class="mi">196</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert size in degrees to size in pixels for a given Monitor object&quot;&quot;&quot;</span> 

    <span class="c1"># get monitor params and raise error if necess</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scrWidthCm</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scrDist</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
        <span class="n">scrWidthCm</span> <span class="o">=</span> <span class="n">prf_object</span><span class="o">.</span><span class="n">screen_size_cm</span>
        <span class="n">scrDist</span> <span class="o">=</span> <span class="n">prf_object</span><span class="o">.</span><span class="n">screen_distance_cm</span>

    <span class="n">cmSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span> <span class="o">*</span> <span class="n">scrDist</span> <span class="o">*</span> <span class="mf">0.017455</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">cmSize</span> <span class="o">*</span> <span class="n">scrSizePix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">scrWidthCm</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span></div>



<span class="c1"># get onset times from select_stims</span>
<div class="viewcode-block" id="get_onset_idx">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.get_onset_idx">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_onset_idx</span><span class="p">(</span><span class="n">design</span><span class="p">):</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">design</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">design</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">idx</span></div>



<span class="c1"># create design matrix by selecting</span>
<div class="viewcode-block" id="select_stims">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.select_stims">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_stims</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">,</span> <span class="n">stim_library</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">225</span><span class="p">,</span> <span class="n">baseline_frames</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">TR</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">return_onsets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">settings_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;select_stims</span>

<span class="sd">    Function to create a fictitious design matrix based on the &#39;lib&#39;-variable containing a library of 4 different types of bar</span>
<span class="sd">    stimuli: &#39;hori&#39; (horizontal), &#39;vert&#39; (vertical) &#39;rot_45&#39; (horizontal bars rotated 45 degrees counterclockwise), and</span>
<span class="sd">    &#39;rot_135&#39; (horizontal bars rotated 135 degrees counterclockwise). Using a &#39;settings&#39;-dictionary, you can specify how many</span>
<span class="sd">    and which of each of these stimuli you want.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings_dict: dict</span>
<span class="sd">        dictionary containing the number of stimuli and index of stimuli (as per the library) that you would like to include.</span>
<span class="sd">        An example is:</span>
<span class="sd">        </span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            use_settings = {</span>
<span class="sd">            &#39;hori&#39;: [0, 18],</span>
<span class="sd">            &#39;vert&#39;: [4, 25],</span>
<span class="sd">            &#39;rot_45&#39;: [4, 18],</span>
<span class="sd">            &#39;rot_135&#39;: [0, 5]</span>
<span class="sd">            }</span>

<span class="sd">        this selects 0 horizontal stimuli, 4x the 25th vertical stimulus in &#39;lib&#39;, 4x the 18th stimulus of the 45 degree</span>
<span class="sd">        rotated stimuli, and 0 of the 135 degree rotated stimuli.</span>
<span class="sd">    stim_library: dict</span>
<span class="sd">        library containing different types of stimuli. Can be create with :func:`fmriproc.prf.create_stim_library`</span>
<span class="sd">    frames: int </span>
<span class="sd">        number of frames your design matrix should have. Should be the same as your functional data in terms of TR (default =</span>
<span class="sd">        225)!</span>
<span class="sd">    baseline_frames: int </span>
<span class="sd">        number of baseline frames before stimulus presentation begins. Only needs to be specified if &#39;randomize&#39; is set to</span>
<span class="sd">        False (default = 15).</span>
<span class="sd">    randomize: bool </span>
<span class="sd">        boolean whether you want to completely randomize your experiment or not. Generally you&#39;ll want to set this to false,</span>
<span class="sd">        to create a regular intervals between stimuli (default = False).</span>
<span class="sd">    shuffle: bool </span>
<span class="sd">        if randomize is turned off, we can still shuffle the order of the stimulus presentations. This you can do by setting</span>
<span class="sd">        shuffle to True (default = True)</span>
<span class="sd">    verbose: bool, optional</span>
<span class="sd">        Set to True if you want some messages along the way (default = False)</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        &lt;n_pix,n_pix,frames&gt; numpy array representing your design</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># except:</span>
    <span class="c1">#     raise ValueError(f&quot;Could not open &#39;stimulus_library.pkl&#39;-file in {pname}&quot;)</span>

    <span class="n">lib</span> <span class="o">=</span> <span class="n">stim_library</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">onset_idx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">index_shuf</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">hori</span>        <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;hori&#39;</span><span class="p">]</span>
        <span class="n">vert</span>        <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;vert&#39;</span><span class="p">]</span>
        <span class="n">rot_45</span>      <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;rot_45&#39;</span><span class="p">]</span>
        <span class="n">rot_135</span>     <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;rot_135&#39;</span><span class="p">]</span>
        <span class="n">filled</span>      <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;filled&#39;</span><span class="p">]</span>
        <span class="n">conc</span>        <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">select_stims</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not extract relevant information; check the doc for an example of settings_dict&quot;</span><span class="p">)</span>

    <span class="n">total_stims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">settings_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating design with </span><span class="si">{</span><span class="n">total_stims</span><span class="si">}</span><span class="s2"> stimuli and length of </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">stims</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># get stims for each orientation</span>
    <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">settings_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Using </span><span class="si">{</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> stimuli of &#39;</span><span class="si">{</span><span class="n">ori</span><span class="si">}</span><span class="s2">&#39;-orientation&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">idc_list</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">onset_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">idc_list</span><span class="p">,</span> <span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">stims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lib</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idc_list</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

                <span class="n">stims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">idc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idc</span> <span class="o">=</span> <span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">settings_dict</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">stims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lib</span><span class="p">[</span><span class="n">ori</span><span class="p">][</span><span class="n">idc</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stimuli have shape </span><span class="si">{</span><span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stimuli have shape </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># fill to end of frames</span>
    <span class="n">nr_stims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span>
    <span class="n">fill_stims</span> <span class="o">=</span> <span class="n">frames</span> <span class="o">-</span> <span class="n">nr_stims</span>

    <span class="c1"># completely randomize trials and baseline</span>
    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fill_stims</span><span class="p">):</span>
            <span class="n">stims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stims</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">stims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stims</span><span class="p">)</span>

        <span class="n">idc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">frames</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idc</span><span class="p">)</span>
        <span class="n">stims</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="n">idc</span><span class="p">,:,:]</span>

        <span class="k">return</span> <span class="n">stims</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># make regular intervals between stimuli</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">actual_stims</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">actual_stims</span> <span class="o">=</span> <span class="n">total_stims</span>

        <span class="c1"># do ISI calculation as in exptools experiment:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

        <span class="c1"># from exptools2.core.session._load_settings()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>

        <span class="n">total_iti_duration</span> <span class="o">=</span> <span class="n">actual_stims</span> <span class="o">*</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_iti_duration&#39;</span><span class="p">)</span>
        <span class="n">min_iti_duration</span> <span class="o">=</span> <span class="n">total_iti_duration</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_iti_duration_leeway&#39;</span><span class="p">),</span>
        <span class="n">max_iti_duration</span> <span class="o">=</span> <span class="n">total_iti_duration</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_iti_duration_leeway&#39;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">return_itis</span><span class="p">(</span><span class="n">mean_duration</span><span class="p">,</span> <span class="n">minimal_duration</span><span class="p">,</span> <span class="n">maximal_duration</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
            <span class="n">itis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">mean_duration</span><span class="o">-</span><span class="n">minimal_duration</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_trials</span><span class="p">)</span>
            <span class="n">itis</span> <span class="o">+=</span> <span class="n">minimal_duration</span>
            <span class="n">itis</span><span class="p">[</span><span class="n">itis</span><span class="o">&gt;</span><span class="n">maximal_duration</span><span class="p">]</span> <span class="o">=</span> <span class="n">maximal_duration</span>
            <span class="k">return</span> <span class="n">itis</span>

        <span class="n">nits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">itis</span> <span class="o">=</span> <span class="n">return_itis</span><span class="p">(</span>
            <span class="n">mean_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_iti_duration&#39;</span><span class="p">),</span>
            <span class="n">minimal_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minimal_iti_duration&#39;</span><span class="p">),</span>
            <span class="n">maximal_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maximal_iti_duration&#39;</span><span class="p">),</span>
            <span class="n">n_trials</span><span class="o">=</span><span class="n">actual_stims</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">itis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_iti_duration</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">itis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_iti_duration</span><span class="p">):</span>
            <span class="n">itis</span> <span class="o">=</span> <span class="n">return_itis</span><span class="p">(</span>
                <span class="n">mean_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_iti_duration&#39;</span><span class="p">),</span>
                <span class="n">minimal_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minimal_iti_duration&#39;</span><span class="p">),</span>
                <span class="n">maximal_duration</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maximal_iti_duration&#39;</span><span class="p">),</span>
                <span class="n">n_trials</span><span class="o">=</span><span class="n">actual_stims</span><span class="p">)</span>
            <span class="n">nits</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ITIs created with total ITI duration of </span><span class="si">{</span><span class="n">itis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1"> after </span><span class="si">{</span><span class="n">nits</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="c1"># fetch new nr of frames based on ITIs</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">itis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">TR</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New nr of frames = </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s2"> based on ITIs&quot;</span><span class="p">)</span>

        <span class="c1"># new nr of frames to fill</span>
        <span class="n">fill_stim</span> <span class="o">=</span> <span class="n">frames</span> <span class="o">-</span> <span class="n">actual_stims</span>

        <span class="c1"># fetch how many frames do not have stimulus</span>
        <span class="n">frames_no_stim</span> <span class="o">=</span> <span class="n">fill_stims</span> <span class="o">-</span> <span class="n">baseline_frames</span>

        <span class="c1"># fetch how many frames should be presented between each stimulus</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">frames_no_stim</span><span class="p">)</span><span class="o">/</span><span class="n">actual_stims</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># create (n_pix,n_pix,baseline_frames) array</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">baseline_frames</span><span class="p">)])</span>

        <span class="c1"># initialize list</span>
        <span class="n">chunk_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># loop through stimuli</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">actual_stims</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">stim_array</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stim_array</span> <span class="o">=</span> <span class="n">stims</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

            <span class="c1"># create (n_pix,n_pix,chunk_size) array</span>
            <span class="n">isi_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">itis</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="n">TR</span><span class="p">))])</span>

            <span class="c1"># create chunk with stimulus + isi</span>
            <span class="n">add_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">stim_array</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">isi_chunk</span><span class="p">))</span>

            <span class="c1"># if verbose:</span>
            <span class="c1">#     print(f&quot; Added chunk nr {ii} with shape: {add_chunk.shape}&quot;)</span>

            <span class="n">chunk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_chunk</span><span class="p">)</span>

        <span class="c1"># shuffle the order of stimulus presentations</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">onset_idx</span><span class="p">:</span>

                <span class="c1"># I do this so we can keep track of which stimulus in the list was presented</span>
                <span class="n">chunk_list_shuff</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stim_shuff</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">index_shuf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">onset_idx</span><span class="p">))</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">index_shuf</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_shuf</span><span class="p">:</span>
                    <span class="n">chunk_list_shuff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">stim_shuff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onset_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">)</span>
                <span class="n">chunk_list_shuff</span> <span class="o">=</span> <span class="n">chunk_list</span>

        <span class="c1"># add baseline at the beginning</span>
        <span class="n">chunk_list_shuff</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">baseline</span><span class="p">)</span>

        <span class="c1"># concatenate into a numpy array</span>
        <span class="n">design</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">chunk_list_shuff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># if verbose:</span>
        <span class="c1">#     print(f&quot;Current design shape = {design.shape}&quot;)</span>

        <span class="c1"># # add or cut frames at the end to meet the nr of frames</span>
        <span class="c1"># if design.shape[-1] &gt; frames:</span>
        <span class="c1">#     if verbose:</span>
        <span class="c1">#         print(f&quot;Removing {design.shape[-1]-frames} frames&quot;)</span>

        <span class="c1">#     design = design[:,:,:frames]</span>
        <span class="c1"># elif design.shape[-1] &lt; frames:</span>
        <span class="c1">#     if verbose:</span>
        <span class="c1">#         print(f&quot;Adding {frames-design.shape[-1]} frames&quot;)</span>
        <span class="c1">#     design = np.dstack((design, np.dstack([np.zeros_like(ref) for i in range(frames-design.shape[-1])])))</span>
        
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Design has shape: </span><span class="si">{</span><span class="n">design</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_onsets</span><span class="p">:</span>
            <span class="c1"># # create onset df</span>
            <span class="c1"># try:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Creating onset dataframe&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">onset_frames</span> <span class="o">=</span> <span class="n">get_onset_idx</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>
            <span class="n">onset_times</span> <span class="o">=</span> <span class="n">onset_frames</span><span class="o">*</span><span class="n">TR</span>

            <span class="n">onset_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">onset_times</span><span class="p">,</span>
                          <span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="n">stim_shuff</span><span class="p">}</span>

            <span class="n">onset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">onset_dict</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">design</span><span class="p">,</span> <span class="n">onset_df</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">design</span></div>


<div class="viewcode-block" id="prf_neighbouring_vertices">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.prf_neighbouring_vertices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prf_neighbouring_vertices</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="n">vertex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prf_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vertices_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;prf_neighbouring_vertices</span>

<span class="sd">    Function to extract pRF-parameters from vertices neighbouring a particular vertex of interest. Internally uses</span>
<span class="sd">    &quot;call_prfinfo&quot; to extract the parameters, so it assumes a particular kind of data structure (for now..)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject: str</span>
<span class="sd">        string used as subject ID (e.g., &#39;sub-001&#39;)</span>
<span class="sd">    hemi: str </span>
<span class="sd">        string (&#39;lh&#39;|&#39;rh&#39;) used to annotate the hemisphere which is required to index the correct pRF parameters</span>
<span class="sd">    vertex: int</span>
<span class="sd">        vertex from which to extract neighbouring vertices</span>
<span class="sd">    prf_params: str, np.ndarray</span>
<span class="sd">        if you do not want to depend on fixed data structures, you can specify the pRF-parameters directly with a string</span>
<span class="sd">        pointing to a numpy-file or the numpy-array itself</span>
<span class="sd">    compare: bool</span>
<span class="sd">        if True, it will compare the parameters of neighbouring vertices with the parameters of &lt;vertex&gt;</span>
<span class="sd">    vertices_only: bool</span>
<span class="sd">        only return the vertices, not their pRF-parameters (which might depend on a certain project structure)</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    list</span>
<span class="sd">        list of dictionaries containing the pRF-parameters for each vertex</span>

<span class="sd">    list</span>
<span class="sd">        list of the neighbouring vertices</span>

<span class="sd">    Notes</span>
<span class="sd">    ----------</span>
<span class="sd">    Note that the last element in both is the information about the requested vertex itself!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify vertex from which to extract neighbours&quot;</span><span class="p">)</span>

    <span class="c1"># fetch the surface used for vertex extraction</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s2">.fiducial&quot;</span><span class="p">,</span> <span class="n">opj</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SUBJECTS_DIR&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;surf&#39;</span><span class="p">))</span>

    <span class="c1"># define the command to fetch neighbouring vertices</span>
    <span class="n">cmd_2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mris_info&#39;</span><span class="p">,</span> <span class="s1">&#39;--vx&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vertex</span><span class="p">),</span> <span class="n">surf</span><span class="p">)</span>

    <span class="c1"># read the output</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd_2</span><span class="p">))</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="c1"># read number of neighbours</span>
    <span class="n">n_neighbours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">L</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">n_neighbours</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vertex only has a few neighbours..?&quot;</span><span class="p">)</span>

    <span class="c1"># loop through neighbouring vertices to extract their vertices</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list_neighbours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_neighbours</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">list_neighbours</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nbr&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">list_neighbours</span><span class="p">[</span><span class="n">ii</span><span class="p">]):</span>
            <span class="n">verts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">verts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vertices_only</span><span class="p">:</span>
        <span class="c1"># extract pRF parameters for each vertex</span>
        <span class="n">prfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">:</span>
            <span class="n">cmd_1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;call_prfinfo&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject</span><span class="p">),</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">hemi</span><span class="p">))</span>
            <span class="n">prfs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd_1</span><span class="p">))</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">compare</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Vertex </span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">prfs</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">el</span><span class="p">]</span><span class="o">/</span><span class="n">prfs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">prfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="n">el</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">% similar&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prfs</span><span class="p">,</span> <span class="n">verts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">verts</span></div>


<div class="viewcode-block" id="create_line_prf_matrix">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.create_line_prf_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_line_prf_matrix</span><span class="p">(</span>
    <span class="n">log_dir</span><span class="p">,</span> 
    <span class="n">nr_trs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stim_at_half_TR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">TR</span><span class="o">=</span><span class="mf">0.105</span><span class="p">,</span> 
    <span class="n">n_pix</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> 
    <span class="n">deleted_first_timepoints</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
    <span class="n">deleted_last_timepoints</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
    <span class="n">stim_duration</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">baseline_before</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">baseline_after</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">skip_first_img</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dm_edges_clipping</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;create_line_prf_matrix</span>

<span class="sd">    Adaptation of get_prfdesign. Uses a similar principle, but rather than having an image per TR, we have images with onset</span>
<span class="sd">    times. With this function we can fill in an empty design matrix with size of n_samples to create the design matrix. This</span>
<span class="sd">    holds for cases where the stimulus duration is modulo the repetition time (e.g., stim duration = 0.315, repetition time =</span>
<span class="sd">    0.105). In cases where the stimulus duration is incongruent with the repetition time, we can loop through the repetition</span>
<span class="sd">    times and find, in the onsets dataframe, the closest time and select that stimulus for our design matrix. This later case</span>
<span class="sd">    works for the partial pRF experiment that we run with 3D-EPI 1.1s TR acquisition, and should work with the line-scanning</span>
<span class="sd">    acquisition as well.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_dir: str</span>
<span class="sd">        path to the log-directory as per the output of exptools experiments. We should have a &quot;Screenshots&quot;-directory in there</span>
<span class="sd">        and a *.tsv*-file containing the onset times</span>
<span class="sd">    nr_trs: int</span>
<span class="sd">        number of TRs in an acquisition run; this one is required if the stimulus duration is not modulo the repetition time</span>
<span class="sd">    TR: float (default = 0.105s)</span>
<span class="sd">        repetition time of scan acquisition. Needed to convert the onset times from seconds to TRs</span>
<span class="sd">    stim_at_half_TR: bool</span>
<span class="sd">        set to True if you want the stimulus halfway through the TR. This flag can be used in combination with &lt;nr_trs&gt;, when</span>
<span class="sd">        the stimulus duration is not modulo the repetition time</span>
<span class="sd">    deleted_first_timepoints: int </span>
<span class="sd">        number of volumes to skip in the beginning; should be the same as used in ParseFunc-file and/or ParseFuncFile (if used</span>
<span class="sd">        in concert) (default = 0)</span>
<span class="sd">    deleted_last_timepoints: int</span>
<span class="sd">        number of volumes to skip at the end; should be the same as used in ParseFuncFile and/or ParseFuncFile (if used in</span>
<span class="sd">        concert) (default = 0)</span>
<span class="sd">    n_pix: int </span>
<span class="sd">        size determinant of the design matrix. Note, &lt;n_pix&gt; is hardcoded as well in the function itself because I ran stuff</span>
<span class="sd">        on my laptop and that screen has a different size than the stimulus computer @Spinoza (default = 270px)</span>
<span class="sd">    stim_duration: float</span>
<span class="sd">        length of stimulus presentation (in seconds; default = 1s)</span>
<span class="sd">    skip_first_img: boolean </span>
<span class="sd">        depending on how you coded the screenshot capturing, the first empty screen is something also captured. With this flag</span>
<span class="sd">        we can skip that image (default = True).</span>
<span class="sd">    dm_edges_clipping: list, dict, optional</span>
<span class="sd">        people don&#39;t always see the entirety of the screen so it&#39;s important to check what the subject can actually see by</span>
<span class="sd">        showing them the cross of for instance the BOLD-screen (the matlab one, not the linux one) and clip the image</span>
<span class="sd">        accordingly</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        design matrix with size &lt;n_pix, n_pix, n_samples&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">screenshot_path</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span><span class="s2">&quot;Screenshot&quot;</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Found multiple (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">)</span><span class="si">}</span><span class="s2">) instances for &#39;Screenshot&#39;. Maybe hidden directories from</span>
<span class="s2">                        MacOS?; </span><span class="se">\n</span><span class="si">{</span><span class="n">screenshot_path</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">image_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">)</span>
    <span class="n">image_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">tr_in_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stim_duration</span><span class="o">/</span><span class="n">TR</span><span class="p">)</span>

    <span class="c1">#clipping edges; top, bottom, left, right</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dm_edges_clipping</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">dm_edges_clipping</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
            <span class="n">dm_edges_clipping</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]]</span>    

    <span class="c1"># whether the stimulus duration is modulo the repetition time or not differs. In case it is, </span>
    <span class="c1"># we can use the loop below. If not, we need to loop through the TRs, find the onset time </span>
    <span class="c1"># closest to it, and select that particular image</span>

    <span class="c1"># get first image to get screen size</span>
    <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="n">image_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">round</span><span class="p">(</span><span class="n">stim_duration</span> <span class="o">%</span> <span class="n">TR</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># define native resolution design matrix</span>
        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="o">*</span><span class="n">tr_in_duration</span><span class="p">)))</span>

        <span class="n">point</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">:</span>
            <span class="n">img_fn</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_fn</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:(</span><span class="n">offset</span><span class="o">+</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

            <span class="c1"># first binarize, then downsample</span>
            <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">point</span><span class="p">:</span><span class="n">point</span><span class="o">+</span><span class="n">tr_in_duration</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">point</span> <span class="o">+=</span> <span class="n">tr_in_duration</span>

        <span class="c1">#top, bottom, left, right</span>
        <span class="n">design_matrix</span><span class="p">[:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">3</span><span class="p">]):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># downsample (resample2d can also deal with 3D input)</span>
        <span class="n">dm_resampled</span> <span class="o">=</span> <span class="n">resample2d</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">)</span>

        <span class="c1"># deal with baseline and deleted volumes</span>
        <span class="n">baseline_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">baseline_before</span><span class="o">/</span><span class="n">TR</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">deleted_first_timepoints</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">baseline_before</span> <span class="o">=</span> <span class="n">baseline_before</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">deleted_first_timepoints</span><span class="p">:]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline before has shape: </span><span class="si">{</span><span class="n">baseline_before</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">baseline_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">baseline_after</span><span class="o">/</span><span class="n">TR</span><span class="p">)))</span>    
        <span class="k">if</span> <span class="n">deleted_last_timepoints</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">baseline_after</span> <span class="o">=</span> <span class="n">baseline_after</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="o">-</span><span class="n">deleted_last_timepoints</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Design itself has shape: </span><span class="si">{</span><span class="n">dm_resampled</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline after has shape: </span><span class="si">{</span><span class="n">baseline_after</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">baseline_before</span><span class="p">,</span> <span class="n">dm_resampled</span><span class="p">,</span> <span class="n">baseline_after</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">dm</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="c1"># define empty design matrix</span>
        <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nr_trs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading onset times from log-file&quot;</span><span class="p">)</span>

        <span class="c1"># get the onsets</span>
        <span class="n">onsets</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">ParseExpToolsFile</span><span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">),</span> 
            <span class="n">TR</span><span class="o">=</span><span class="n">TR</span><span class="p">,</span> 
            <span class="n">deleted_first_timepoints</span><span class="o">=</span><span class="n">deleted_first_timepoints</span><span class="p">,</span> 
            <span class="n">use_bids</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">phase_onset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">trial_df</span> <span class="o">=</span> <span class="n">onsets</span><span class="o">.</span><span class="n">get_onset_df</span><span class="p">()</span>

        <span class="n">settings_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">([</span><span class="s1">&#39;yml&#39;</span><span class="p">],</span> <span class="n">log_dir</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
        <span class="c1"># check baseline first</span>
        <span class="n">baseline_start</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_duration&#39;</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Creating design matrix (can take a few minutes with thousands of TRs)&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># compatible with lineprf2</span>
        <span class="k">if</span> <span class="s2">&quot;baseline&quot;</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">trial_df</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>

            <span class="c1"># find blank onsets; parse ranges into list of tuples and check if tr_in_sec falls in that range or not</span>
            <span class="c1"># https://stackoverflow.com/a/6054040</span>
            <span class="n">blank_periods</span> <span class="o">=</span> <span class="n">trial_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">trial_df</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;blank&#39;</span><span class="p">)][</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">blank_duration</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inter_sweep_blank&#39;</span><span class="p">)</span>
            <span class="n">blank_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">blank_duration</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">blank_periods</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_trs</span><span class="p">):</span>
                
                <span class="c1"># find time at the middle of TR</span>
                <span class="k">if</span> <span class="n">stim_at_half_TR</span><span class="p">:</span>
                    <span class="n">tr_in_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span> <span class="o">*</span> <span class="n">onsets</span><span class="o">.</span><span class="n">TR</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">onsets</span><span class="o">.</span><span class="n">TR</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tr_in_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span> <span class="o">*</span> <span class="n">onsets</span><span class="o">.</span><span class="n">TR</span><span class="p">)</span>

                <span class="c1"># start doing stuff if tr_in_sec is greater than baseline</span>
                <span class="k">if</span> <span class="n">tr_in_sec</span> <span class="o">&gt;</span> <span class="n">baseline_start</span><span class="p">:</span>
                    
                    <span class="c1"># check blank area</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">tr_in_sec</span> <span class="o">&lt;=</span> <span class="n">upper</span> <span class="k">for</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blank_ranges</span><span class="p">):</span>

                        <span class="c1"># ix now represents the trial ID in the onset dataframe, which starts at the first &#39;t&#39;</span>
                        <span class="n">ix</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">trial_df</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">tr_in_sec</span><span class="p">)</span>
                        <span class="n">image_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Screenshots</span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">screenshot_path</span><span class="p">,</span> <span class="n">return_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">image_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            
                            <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:(</span><span class="n">offset</span><span class="o">+</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

                            <span class="c1"># binarize image into dm matrix; i use ranges because I have another cue in the screenshots</span>
                            <span class="n">design_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tr</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">))</span> <span class="o">|</span>
                                                            <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># backwards compatibility for older versions of lineprf</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_trs</span><span class="p">):</span>
    
                <span class="c1"># find time at the middle of TR</span>
                <span class="k">if</span> <span class="n">stim_at_half_TR</span><span class="p">:</span>
                    <span class="n">tr_in_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span> <span class="o">*</span> <span class="n">onsets</span><span class="o">.</span><span class="n">TR</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">onsets</span><span class="o">.</span><span class="n">TR</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tr_in_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span> <span class="o">*</span> <span class="n">onsets</span><span class="o">.</span><span class="n">TR</span><span class="p">)</span>

                <span class="c1"># ix now represents the trial ID in the onset dataframe, which starts at the first &#39;t&#39;</span>
                <span class="n">ix</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">trial_df</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">tr_in_sec</span><span class="p">)</span>
                
                <span class="c1"># zero-pad number https://stackoverflow.com/questions/2189800/how-to-find-length-of-digits-in-an-integer</span>
                <span class="n">zfilling</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">screenshot_path</span><span class="p">))))</span>
                <span class="n">img_number</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">zfilling</span><span class="p">)</span>
                <span class="n">search_for</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Screenshots</span><span class="si">{</span><span class="n">img_number</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">image_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span><span class="n">search_for</span><span class="p">,</span> <span class="n">screenshot_path</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">image_file</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found multiple (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="si">}</span><span class="s2">) files for &#39;</span><span class="si">{</span><span class="n">search_for</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">image_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">image_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    
                    <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">offset</span><span class="p">:(</span><span class="n">offset</span><span class="o">+</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

                    <span class="c1"># binarize image into dm matrix</span>
                    <span class="c1"># assumes: standard RGB255 format; only colors present in image are black, white, grey, red, green.</span>
                    <span class="n">design_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tr</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">))</span> <span class="o">|</span>
                                                    <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)))]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING; could not find image for trial #</span><span class="si">{</span><span class="n">tr</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">search_for</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1">#top, bottom, left, right</span>
        <span class="n">design_matrix</span><span class="p">[:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">1</span><span class="p">]):,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[:,</span> <span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dm_edges_clipping</span><span class="p">[</span><span class="mi">3</span><span class="p">]):,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># downsample (resample2d can also deal with 3D input)</span>
        <span class="k">if</span> <span class="n">n_pix</span> <span class="o">!=</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">dm_resampled</span> <span class="o">=</span> <span class="n">resample2d</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">)</span>
            <span class="n">dm_resampled</span><span class="p">[</span><span class="n">dm_resampled</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">dm_resampled</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">design_matrix</span></div>


<div class="viewcode-block" id="create_stim_library">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.create_stim_library">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_stim_library</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">prf_stim</span><span class="p">,</span> <span class="n">range_around_center</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">],</span> <span class="n">concentricity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">stim_factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="mi">26</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create library of stimuli to build a design matrix with&quot;&quot;&quot;</span>

    <span class="c1"># create filled stimuli</span>
    <span class="n">stims_fill</span><span class="p">,</span> <span class="n">stims_fill_sizes</span> <span class="o">=</span> <span class="n">make_stims</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">prf_stim</span><span class="p">,</span> <span class="n">factr</span><span class="o">=</span><span class="n">stim_factor</span><span class="p">)</span>

    <span class="c1"># create concentric stimuli</span>
    <span class="n">stims_conc</span><span class="p">,</span> <span class="n">stims_fill_conc</span> <span class="o">=</span> <span class="n">make_stims</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">prf_stim</span><span class="p">,</span> <span class="n">concentric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">concentric_size</span><span class="o">=</span><span class="n">concentricity</span><span class="p">)</span>    

    <span class="c1"># internally prf.make_stims calculates the number of stimuli. Use that number for the other stimuli as well</span>
    <span class="n">n_stim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stims_fill</span><span class="p">)</span>

    <span class="c1"># create aperture around stimuli</span>
    <span class="n">aperture</span> <span class="o">=</span> <span class="n">create_circular_mask</span><span class="p">(</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">)</span>

    <span class="c1"># center bars</span>
    <span class="n">beam_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">n_pix</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">range_around_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">n_pix</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">range_around_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">num</span><span class="o">=</span><span class="n">n_stim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Create horizontal bars</span>
    <span class="n">horizontal</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">beam_locations</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">horizontal</span><span class="p">):</span>

        <span class="n">total</span> <span class="o">=</span> <span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span>

        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="n">n_pix</span><span class="p">:</span>
            <span class="n">stim</span><span class="p">[</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]:</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remains</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">n_pix</span>
            <span class="n">stim</span><span class="p">[</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]:(</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span><span class="p">)</span><span class="o">-</span><span class="n">remains</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">stim</span><span class="p">[</span><span class="o">~</span><span class="n">aperture</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># create vertical bars</span>
    <span class="n">vertical</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span> <span class="n">n_pix</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">beam_locations</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vertical</span><span class="p">):</span>

        <span class="n">total</span> <span class="o">=</span> <span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span>

        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="n">n_pix</span><span class="p">:</span>
            <span class="n">stim</span><span class="p">[:,</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]:</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remains</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">n_pix</span>
            <span class="n">stim</span><span class="p">[:,</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]:(</span><span class="n">beam_locations</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">+</span><span class="n">beam_size</span><span class="p">)</span><span class="o">-</span><span class="n">remains</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">stim</span><span class="p">[</span><span class="o">~</span><span class="n">aperture</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># rotate vertical bars by 45 degrees</span>
    <span class="n">rot45</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vertical</span><span class="p">):</span>

        <span class="n">stim_rot</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot45</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_rot</span><span class="p">)</span>

    <span class="c1"># rotate vertical bars by 135 degrees</span>
    <span class="n">rot135</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vertical</span><span class="p">):</span>

        <span class="n">stim_rot</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rot135</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_rot</span><span class="p">)</span>

    <span class="n">lib</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hori&#39;</span><span class="p">:</span> <span class="n">horizontal</span><span class="p">,</span>
           <span class="s1">&#39;vert&#39;</span><span class="p">:</span> <span class="n">vertical</span><span class="p">,</span>
           <span class="s1">&#39;rot_45&#39;</span><span class="p">:</span> <span class="n">rot45</span><span class="p">,</span>
           <span class="s1">&#39;rot_135&#39;</span><span class="p">:</span> <span class="n">rot135</span><span class="p">,</span>
           <span class="s1">&#39;filled&#39;</span><span class="p">:</span> <span class="n">stims_fill</span><span class="p">,</span>
           <span class="s1">&#39;conc&#39;</span><span class="p">:</span> <span class="n">stims_conc</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">lib</span></div>



<div class="viewcode-block" id="distance_centers">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.distance_centers">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">distance_centers</span><span class="p">(</span><span class="n">prf1</span><span class="p">,</span><span class="n">prf2</span><span class="p">):</span>

    <span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">prf1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prf1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">prf2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prf2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Calculating distance</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span></div>

 

<div class="viewcode-block" id="generate_model_params">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.generate_model_params">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_model_params</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> 
    <span class="n">dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">TR</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
    <span class="n">fit_hrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">old_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hrf</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;generate_model_params</span>

<span class="sd">    Function to generate a yaml-file with parameters to use. Utilizes the</span>
<span class="sd">    [prf_analysis.yml](https://github.com/gjheij/fmriproc/blob/main/misc/prf_analysis.yml) as basis, but it&#39;s advised to copy</span>
<span class="sd">    the file to the `DIR_DATA_HOME/code`-folder so you have a project-specific template. Depending on the model, we&#39;ll add</span>
<span class="sd">    grids and bounds and return a dictionary of settings. This dictionary is saved in the `pkl`-file as per the output of</span>
<span class="sd">    :class:`fmriproc.prf.pRFmodelFitting`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: str</span>
<span class="sd">        model type to utilize.</span>
<span class="sd">    dm: numpy.ndarray</span>
<span class="sd">        design matrix, n_pix X n_pix X volumes. Needed to create the pRF stimulus</span>
<span class="sd">    TR: float</span>
<span class="sd">        repetition time; can be fetched from gifti-file; default = 1.5</span>
<span class="sd">    fit_hrf: bool</span>
<span class="sd">        Whether or not to fit two extra parameters for hrf derivative and dispersion. The default is False.</span>
<span class="sd">    old_settings: dict, optional</span>
<span class="sd">        Dictionary describing an existing set of settings (e.g., from previous fit)</span>
<span class="sd">    hrf: list, optional</span>
<span class="sd">        List of HRF parameters if it deviates from hrf parameters in settings file.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing the settings</span>
<span class="sd">    :class:`prfpy.stimlus.PRFStimulus2D`-object</span>
<span class="sd">        pRF stimulus object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># check if we have project-specific template; otherwise take fmriproc-repo template</span>
    <span class="c1"># it&#39;s in a try-except loop because sometimes os.environ.get fails, causing a premature error..</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">yml_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span>
            <span class="s2">&quot;prf_analysis.yml&quot;</span><span class="p">,</span>
            <span class="n">opj</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DIR_DATA_HOME&quot;</span><span class="p">),</span> <span class="s1">&#39;code&#39;</span><span class="p">),</span>
            <span class="n">return_msg</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">yml_file</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">yml_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        
        <span class="n">yml_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span>
            <span class="s2">&quot;prf_analysis.yml&quot;</span><span class="p">,</span>
            <span class="n">opj</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fmriproc</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;misc&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_settings</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yml_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading settings from &#39;</span><span class="si">{</span><span class="n">yml_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yml_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not read settings&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading manually specified settings&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">old_settings</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
    
    <span class="n">prf_stim</span> <span class="o">=</span> <span class="n">stimulus</span><span class="o">.</span><span class="n">PRFStimulus2D</span><span class="p">(</span>
        <span class="n">screen_size_cm</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_size_cm&#39;</span><span class="p">],</span>
        <span class="n">screen_distance_cm</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_distance_cm&#39;</span><span class="p">],</span>
        <span class="n">design_matrix</span><span class="o">=</span><span class="n">dm</span><span class="p">,</span>
        <span class="n">TR</span><span class="o">=</span><span class="n">TR</span><span class="p">)</span>

    <span class="n">ss</span> <span class="o">=</span> <span class="n">prf_stim</span><span class="o">.</span><span class="n">screen_size_degrees</span>
    <span class="n">max_ecc_size</span> <span class="o">=</span> <span class="n">ss</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="c1"># define grids</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">max_ecc_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grid_nr&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">eccs</span> <span class="o">=</span> <span class="n">max_ecc_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grid_nr&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">polars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grid_nr&#39;</span><span class="p">])</span>

    <span class="n">coord_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="o">*</span><span class="n">max_ecc_size</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">max_ecc_size</span><span class="p">)</span>
    <span class="n">prf_size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>

    <span class="n">hrf1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">hrf2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">grids</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;screensize_degrees&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ss</span><span class="p">),</span> 
        <span class="s1">&#39;grids&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;sizes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">],</span> 
            <span class="s1">&#39;eccs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">eccs</span><span class="p">],</span> 
            <span class="s1">&#39;polars&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">polars</span><span class="p">],</span>
            <span class="s1">&#39;hrf1&#39;</span><span class="p">:</span> <span class="n">hrf1</span><span class="p">,</span>
            <span class="s1">&#39;hrf2&#39;</span><span class="p">:</span> <span class="n">hrf2</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">allowed_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="s1">&#39;abd&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_models</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model must be one of </span><span class="si">{</span><span class="n">allowed_models</span><span class="si">}</span><span class="s2">. Not &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># define standard bounds, then add model-specific stuff</span>
    <span class="n">standard_bounds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">coord_bounds</span><span class="p">,</span>           <span class="c1"># x</span>
        <span class="n">coord_bounds</span><span class="p">,</span>           <span class="c1"># y</span>
        <span class="n">prf_size</span><span class="p">,</span>               <span class="c1"># prf size</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">],</span>   <span class="c1"># prf amplitude</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">]</span>    <span class="c1"># bold baseline</span>
    <span class="p">]</span>
    
    <span class="c1"># define bounds</span>
    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
        <span class="n">gauss_bounds</span> <span class="o">=</span> <span class="n">standard_bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">gauss_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">gauss_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gauss_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> 
                <span class="s1">&#39;prf_ampl&#39;</span><span class="p">:</span> <span class="n">gauss_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
                <span class="s1">&#39;bold_bsl&#39;</span><span class="p">:</span> <span class="n">gauss_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
        <span class="n">css_bounds</span> <span class="o">=</span> <span class="n">standard_bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;css_exponent&#39;</span><span class="p">]]</span> <span class="c1"># CSS exponent</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">css_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">css_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">css_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="s1">&#39;prf_ampl&#39;</span><span class="p">:</span> <span class="n">css_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;bold_bsl&#39;</span><span class="p">:</span> <span class="n">css_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">&#39;css_exponent&#39;</span><span class="p">:</span> <span class="n">css_bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
        <span class="n">dog_bounds</span> <span class="o">=</span> <span class="n">standard_bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">settings</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;surround_amplitude_bound&#39;</span><span class="p">],</span>    <span class="c1"># surround amplitude</span>
            <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>                         <span class="c1"># surround size</span>
        <span class="p">]</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dog_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dog_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dog_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="s1">&#39;prf_ampl&#39;</span><span class="p">:</span> <span class="n">dog_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s1">&#39;bold_bsl&#39;</span><span class="p">:</span> <span class="n">dog_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">&#39;surr_ampl&#39;</span><span class="p">:</span> <span class="n">dog_bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;surr_size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dog_bounds</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># set D-param to 1</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="p">:</span>
            <span class="n">neur_bsl_bound</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">surr_bsl_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_baseline_bound&#39;</span><span class="p">]</span>
        <span class="c1"># set C-param to 1</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;abd&quot;</span><span class="p">:</span>
            <span class="n">neur_bsl_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;neural_baseline_bound&#39;</span><span class="p">]</span>
            <span class="n">surr_bsl_bound</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># ful model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neur_bsl_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;neural_baseline_bound&#39;</span><span class="p">]</span>
            <span class="n">surr_bsl_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_baseline_bound&#39;</span><span class="p">]</span>

        <span class="n">norm_bounds</span> <span class="o">=</span> <span class="n">standard_bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_amplitude_bound&#39;</span><span class="p">],</span>    <span class="c1"># surround amplitude</span>
            <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eps&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="o">*</span><span class="n">ss</span><span class="p">),</span>                        <span class="c1"># surround size</span>
            <span class="n">neur_bsl_bound</span><span class="p">,</span>                                 <span class="c1"># neural baseline</span>
            <span class="n">surr_bsl_bound</span>                                  <span class="c1"># surround baseline</span>
        <span class="p">]</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">norm_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">norm_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> 
                <span class="s1">&#39;prf_ampl&#39;</span><span class="p">:</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
                <span class="s1">&#39;bold_bsl&#39;</span><span class="p">:</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s1">&#39;surr_ampl&#39;</span><span class="p">:</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                <span class="s1">&#39;surr_size&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                <span class="s1">&#39;neur_bsl&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">norm_bounds</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
                <span class="s1">&#39;surr_bsl&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">norm_bounds</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">fit_hrf</span><span class="p">:</span>
        <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;hrf&quot;</span><span class="p">][</span><span class="s2">&quot;deriv_bound&quot;</span><span class="p">]</span>
        <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;hrf&quot;</span><span class="p">][</span><span class="s2">&quot;disp_bound&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fix parameters of HRF is array or list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hrf</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">hrf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;hrf&quot;</span><span class="p">][</span><span class="s2">&quot;pars&quot;</span><span class="p">]</span>

        <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ref</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span>
        <span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2</span>

    <span class="c1"># update settings file if we&#39;ve generated a new one</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grids</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">})</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;TR&#39;</span><span class="p">:</span> <span class="n">TR</span><span class="p">})</span>

    <span class="c1"># print important settings</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---------------------------------------------------------------------------------------------------&quot;</span><span class="p">,</span>
        <span class="n">verbose</span>
    <span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Check these important settings!&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Screen distance: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_distance_cm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">cm&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Screen size: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_size_cm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">cm&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; TR: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TR&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
        <span class="s2">&quot;---------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">verbose</span>
    <span class="p">)</span>

    <span class="c1"># return</span>
    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">prf_stim</span></div>


<div class="viewcode-block" id="GaussianModel">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.GaussianModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GaussianModel</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     

        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span> <span class="o">=</span> <span class="n">Iso2DGaussianFitter</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_model</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_jobs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            
            <span class="c1"># check if dimensions make sense</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Matching old parameters of shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to data of shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># set inserted params as gridsearch_params and iterative_search_params</span>
            <span class="c1"># needed for the rsq-mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c1"># actual parameters</span>

            <span class="c1"># set gaussian_fitter as previous_gaussian_fitter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inserting parameters from </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">)</span><span class="si">}</span><span class="s2"> as &#39;iterative_search_params&#39; in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>

<div class="viewcode-block" id="GaussianModel.gridfit">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.GaussianModel.gridfit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gridfit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">## start grid fit</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting Gaussian gridfit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">grid_fit</span><span class="p">(</span>
            <span class="n">ecc_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grids&#39;</span><span class="p">][</span><span class="s1">&#39;eccs&#39;</span><span class="p">],</span>
            <span class="n">polar_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grids&#39;</span><span class="p">][</span><span class="s1">&#39;polars&#39;</span><span class="p">],</span>
            <span class="n">size_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;grids&#39;</span><span class="p">][</span><span class="s1">&#39;sizes&#39;</span><span class="p">],</span>
            <span class="n">fixed_grid_baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_grid_baseline</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">grid_bounds</span><span class="o">=</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">])],</span>
            <span class="n">n_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_jobs</span>
        <span class="p">)</span>
        
        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gauss_grid</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">filter_for_nans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">)</span>
        <span class="n">mean_rsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_grid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_grid</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># verbose stuff</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_grid</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">])</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Completed Gaussian gridfit at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">. Voxels/vertices above </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Gridfit took </span><span class="si">{</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Mean rsq&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_rsq</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_grid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">)</span> </div>


<div class="viewcode-block" id="GaussianModel.iterfit">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.GaussianModel.iterfit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iterfit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting Gaussian iterfit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="c1"># fetch bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gauss_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_bounds</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">)</span>

        <span class="c1"># get optimizer arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_kws_gauss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_optimizer_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">iterative_fit</span><span class="p">(</span>
            <span class="n">rsq_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">],</span> 
            <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_bounds</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_kws_gauss</span>
        <span class="p">)</span>

        <span class="c1"># print summary</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>              
        <span class="bp">self</span><span class="o">.</span><span class="n">gauss_iter</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">filter_for_nans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span><span class="p">)</span>

        <span class="c1"># verbose stuff</span>
        <span class="n">mean_rsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gauss_iter</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">rsq_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Completed Gaussian iterfit at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">. Mean rsq&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_rsq</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iterfit took </span><span class="si">{</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># save intermediate files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">)</span>  </div>
</div>

            
<div class="viewcode-block" id="ExtendedModel">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.ExtendedModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExtendedModel</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_fitter</span> <span class="o">=</span> <span class="n">DoG_Iso2DGaussianFitter</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_fitter</span> <span class="o">=</span> <span class="n">CSS_Iso2DGaussianFitter</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_fitter</span> <span class="o">=</span> <span class="n">Norm_Iso2DGaussianFitter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">)</span>

        <span class="c1"># define fitter; previous_gaussian_fitter can be specified in kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_fit_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;use_previous_gaussian_fitter_hrf&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_hrf</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;previous_gaussian_fitter&quot;</span><span class="p">):</span>

            <span class="c1"># check if we have gaussian fit</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gaussian_fitter&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ext_fit_kws</span><span class="p">[</span><span class="s2">&quot;previous_gaussian_fitter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inject existing-model object &gt; advised when fitting the HRF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_fit_kws</span><span class="p">[</span><span class="s2">&quot;previous_gaussian_fitter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span>

        <span class="c1"># initialize Fitter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_fitter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_model</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_jobs</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_fit_kws</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ExtendedModel.define_grid_bounds">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.ExtendedModel.define_grid_bounds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_grid_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># define grids into lists so we can call gridfit ones</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
            <span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;css&#39;</span><span class="p">][</span><span class="s1">&#39;css_exponent_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">grid_bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
            <span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dog&#39;</span><span class="p">][</span><span class="s1">&#39;dog_surround_amplitude_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dog&#39;</span><span class="p">][</span><span class="s1">&#39;dog_surround_size_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">grid_bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">]),</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_ampl&#39;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
            <span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_amplitude_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_size_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;neural_baseline_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">][</span><span class="s1">&#39;surround_baseline_grid&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">grid_bounds</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">]),</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;neur_bsl&#39;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">grid_list</span><span class="p">,</span> <span class="n">grid_bounds</span></div>


<div class="viewcode-block" id="ExtendedModel.gridfit">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.ExtendedModel.gridfit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gridfit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1">#----------------------------------------------------------------------------------------------------------------------------------------------------------</span>

        <span class="c1"># get list of bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_grid_bounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        
        <span class="c1"># grid fit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_grid</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_grid_bounds</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Ignoring grid bounds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1">## Start grid fit</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> gridfit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">grid_fit</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">,</span>
                <span class="n">n_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nr_jobs</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">rsq_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">],</span>
                <span class="n">fixed_grid_baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_grid_baseline</span><span class="p">,</span>
                <span class="n">grid_bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_bounds</span>
            <span class="p">)</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

            <span class="c1">### save grid parameters</span>
            <span class="n">filtered_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">filter_for_nans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_grid&quot;</span><span class="p">,</span> <span class="n">filtered_</span><span class="p">)</span>

            <span class="c1"># verbose stuff</span>
            <span class="n">mean_rsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filtered_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">gridsearch_rsq_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Completed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> gridfit at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">. Mean rsq&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_rsq</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gridfit took </span><span class="si">{</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_grid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Setting </span><span class="si">{</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span><span class="p">))</span><span class="si">}</span><span class="s2"> as &#39;gridsearch_params&#39; in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_fitter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="p">)</span></div>


<div class="viewcode-block" id="ExtendedModel.iterfit">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.ExtendedModel.iterfit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">iterfit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># fetch bounds from settings &gt; HRF bounds are automatically appended if fit_hrf=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_bounds</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing parameters (idx): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_parameters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unitwise_bounds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fix_parameters</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">ref_pars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span>
            <span class="p">)</span>

        <span class="c1"># these will be fixed in the grid stage, but make sure they&#39;re inherited to iter stage</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_hrf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_hrf_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span><span class="p">,</span>
                <span class="n">ref_pars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span>
            <span class="p">)</span>
            
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_bounds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span><span class="p">)</span>        
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> iterfit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">  at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="c1"># get optimizer arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_kws_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_optimizer_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">iterative_fit</span><span class="p">(</span>
            <span class="n">rsq_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">],</span> 
            <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_bounds</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_kws_ext</span>
        <span class="p">)</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>  

        <span class="c1">### save iterative parameters</span>
        <span class="n">filtered_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">filter_for_nans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">iterative_search_params</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_iter&quot;</span><span class="p">,</span> <span class="n">filtered_</span><span class="p">)</span>

        <span class="c1"># verbose stuff</span>
        <span class="n">mean_rsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">filtered_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">rsq_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Completed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> iterfit at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">. Mean rsq&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;rsq_threshold&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mean_rsq</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iterfit took </span><span class="si">{</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">)</span>   

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_fitter&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="pRFmodelFitting">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">pRFmodelFitting</span><span class="p">(</span><span class="n">GaussianModel</span><span class="p">,</span> <span class="n">ExtendedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pRFmodelFitting</span>

<span class="sd">    Main class to perform all the pRF-fitting. By default, we&#39;ll first look for a `prf_analysis.yml`-file in </span>
<span class="sd">    `DIR_DATA_HOME/code`. If there&#39;s no file there, we&#39;ll take the file provided with the *fmriproc*-repository</span>
<span class="sd">    (https://github.com/gjheij/fmriproc/blob/main/misc/prf_analysis.yml). Generally, the input data is expected to be</span>
<span class="sd">    percent-signal changed where the timecourses are shifted such that the median of the timepoints *without* stimulus is set</span>
<span class="sd">    to 0 (see https://github.com/gjheij/fmriproc/blob/main/bin/call_prf#L267 how this works).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: numpy.ndarray</span>
<span class="sd">        &lt;voxels,time&gt; numpy array | when reading in the data later again, the format must be &lt;time,voxels&gt;. This is highly</span>
<span class="sd">        annoying, but it seems to be required for predictions to work properly.</span>
<span class="sd">    design_matrix: numpy.ndarray</span>
<span class="sd">        &lt;n_pix, n_pix, time&gt; numpy array containing the paradigm</span>
<span class="sd">    TR: float</span>
<span class="sd">        repetition time of acquisition; required for the analysis file. If you&#39;re using gifti-input, you can fetch the TR from</span>
<span class="sd">        that file with `gifti = lazyfmri.dataset.ParseGiftiFile(gii_file).TR_sec`. If you&#39;re file have been created with</span>
<span class="sd">        `fMRIprep` or `call_vol2fsaverage`, this should work.</span>
<span class="sd">    model: str</span>
<span class="sd">        as of now, one of [&#39;gauss&#39;,&#39;dog&#39;,&#39;css&#39;,&#39;norm&#39;] is accepted</span>
<span class="sd">    stage: str</span>
<span class="sd">        Can technically be anything. By default, grid-fits are executed, but if `stage` contains `iter` (e.g.,</span>
<span class="sd">        `stage=&quot;iter&quot;`), an iterative fit is executed as well.</span>
<span class="sd">    output_dir: str</span>
<span class="sd">        directory to store all files in; should be somewhere in &lt;project&gt;/derivatives/prf/&lt;subject&gt;</span>
<span class="sd">    output_base: str</span>
<span class="sd">        basename for output files; should be something like &lt;subject&gt;_&lt;ses-?&gt;_&lt;task-?&gt;</span>
<span class="sd">    write_files: bool</span>
<span class="sd">        save files (True) or not (False). Should be used in combination with &lt;output_dir&gt; and &lt;output_base&gt;</span>
<span class="sd">    old_params: np.ndarray, str, optional</span>
<span class="sd">        A string pointing to an existing file or a numpy array. Internally, the parameters will be assigned to</span>
<span class="sd">        `Iso2DGaussianFitter.gridsearch_params` and `Iso2DGaussianFitter.iterative_search_params`. This fitter object is then</span>
<span class="sd">        assigned to `Iso2DGaussianFitter.previous_gaussian_fitter`, which is then directly inserted in one of the extended</span>
<span class="sd">        models (e.g., `DN`, `DoG`, or `CSS`).</span>
<span class="sd">    hrf: np.ndarray, list, optional</span>
<span class="sd">        &lt;1,time_points&gt; describing the HRF. Can be created with :func:`lazyfmri.glm.double_gamma`, then add an axis before the</span>
<span class="sd">        timepoints:</span>

<span class="sd">        dt = 1</span>
<span class="sd">        time_points = np.linspace(0,36,np.rint(float(36)/dt).astype(int))</span>
<span class="sd">        hrf_custom = lazyfmri.glm.double_gamma(time_points, lag=6)</span>
<span class="sd">        hrf_custom = hrf_custom[np.newaxis,...]</span>

<span class="sd">        Can also be a list of three parameters for the SPM-functions. Defaults to [1,1,0], for the HRF, and the time</span>
<span class="sd">        derivative. </span>
<span class="sd">    fit_hrf: bool</span>
<span class="sd">        fit the HRF with the pRF-parameters as implemented in `prfpy`</span>
<span class="sd">    nr_jobs: int, optional</span>
<span class="sd">        Set the number of jobs. By default 1.</span>
<span class="sd">    verbose: bool, optional</span>
<span class="sd">        Set to True if you want some messages along the way (default = False)</span>
<span class="sd">    constraints: list, str, optional</span>
<span class="sd">        Specify optimizers. Use `tc` for trust-constrained minimization (= slower, but less local. I.e., can move away from</span>
<span class="sd">        the grid), or `bfgs` for L-BFGS-B minimization (lot faster, but more local. I.e., stays closer to the grid). If `tc`</span>
<span class="sd">        or `bgfs`, this minimizer is used for both stages. You can also specify a list where the first element is for</span>
<span class="sd">        *Gaussian*-model and second element is for extended model, e.g., `[&#39;tc&#39;, &#39;bgfs&#39;]`. Generally, the extended model has</span>
<span class="sd">        more parameters so the fit is slower, while the Gaussian-model runs fine with slow optimization (`tc`). Default = `tc`</span>
<span class="sd">        for both stages as it leads to improved *r2*. </span>
<span class="sd">    save_grid: bool, optional</span>
<span class="sd">        Save grid-parameters; can save clogging up of directories. Default = True</span>
<span class="sd">    any: optional</span>
<span class="sd">        You can also provide a value for any key/item present in the default settings-file, e.g., `screen_size_cm`,</span>
<span class="sd">        `rsq_threshold`, `TR`, you name it. This will overwrite the default setting, without the requirement of specifying a</span>
<span class="sd">        new file. Allows for quick tests/adaptations to the default settings. This is especially useful in cases where - pls</span>
<span class="sd">        no.. - you have different screen distances in one dataset.</span>
<span class="sd">    skip_settings: bool, optional</span>
<span class="sd">        avoids overwriting of particular settings (e.g., screen_distance_cm), and takes them from the reference analysis file</span>
<span class="sd">        instead</span>
<span class="sd">    optimizer_kws: dict, optional</span>
<span class="sd">        Extra arguments that will be directly passed on to `scipy:minimize`. x(a)tol/f(a)tol values will be set from the</span>
<span class="sd">        settings file.</span>
<span class="sd">    fix_parameters: list, optional</span>
<span class="sd">        Fix certain parameters from a previous fitting stage for the next. This argument is generally used to fix the position.</span>
<span class="sd">        The BOLD baseline can be fixed to 0 using `fix_bold_baseline=True`, and the HRF can be fixed using `fix_hrf`. The latter</span>
<span class="sd">        requires a bit more attention due to indices differing across models. Only the parameters x, y, prf_size, prf_ampl are</span>
<span class="sd">        the same across models.</span>
<span class="sd">    fix_bold_baseline: bool, optional</span>
<span class="sd">        Fix the baseline of the BOLD to [0, 0]. Generally recommended if your data is already percent signal changed and you</span>
<span class="sd">        would like to do surround-suppression stuff. The default is therefore True.</span>
<span class="sd">    fix_hrf: bool, optional</span>
<span class="sd">        Fix the HRF parameters from a previous fitter. For instance, you run a Gaussian model followed by DoG model and would</span>
<span class="sd">        like to use the fitted parameters from the Gaussian model for the DoG model. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    pkl-file</span>
<span class="sd">        For each model, a pickle file with the settings, parameters, and predictions all in one</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from fmriproc.prf import pRFmodelFitting</span>
<span class="sd">        fitting = pRFmodelFitting(func, design_matrix=dm, model=&#39;gauss&#39;)</span>

<span class="sd">        # we can use this class to read in existing parameter files</span>
<span class="sd">        prf_pfov = opj(prf_new, &quot;sub-003_ses-3_task-pRF_acq-3DEPI_model-norm_stage-iter_desc-prf_params.npy&quot;)</span>
<span class="sd">        modelling_pfov = prf.pRFmodelFitting(</span>
<span class="sd">            partial_nan.T,</span>
<span class="sd">            design_matrix=design_pfov,</span>
<span class="sd">            stage=&quot;iter&quot;,</span>
<span class="sd">            model=&quot;norm&quot;,</span>
<span class="sd">            output_dir=prf_new,</span>
<span class="sd">            output_base=&quot;sub-003_ses-3_task-pRF_acq-3DEPI&quot;)</span>
<span class="sd">        #</span>
<span class="sd">        modelling_pfov.load_params(np.load(prf_pfov), model=&#39;norm&#39;, stage=&#39;iter&#39;)</span>

<span class="sd">    Notes</span>
<span class="sd">    ----------</span>
<span class="sd">    See https://fmriproc.readthedocs.io/en/latest/examples/prfmodelfitter.html for more elaborate example of fitting, loading,</span>
<span class="sd">    visualization, and HRF-fitting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">data</span><span class="p">,</span> 
        <span class="n">design_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">TR</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> 
        <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> 
        <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">write_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">output_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">old_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hrf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fit_hrf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nr_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">prf_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fix_bold_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fix_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fix_hrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="s2">&quot;tc&quot;</span><span class="p">,</span>
        <span class="n">save_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">use_grid_bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span>               <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span>      <span class="o">=</span> <span class="n">design_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span>                 <span class="o">=</span> <span class="n">TR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span>              <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span>              <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>         <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_base</span>        <span class="o">=</span> <span class="n">output_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span>        <span class="o">=</span> <span class="n">write_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings_fn</span>        <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>            <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span>                <span class="o">=</span> <span class="n">hrf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span>         <span class="o">=</span> <span class="n">old_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nr_jobs</span>            <span class="o">=</span> <span class="n">nr_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span>           <span class="o">=</span> <span class="n">prf_stim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span>          <span class="o">=</span> <span class="n">model_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span>            <span class="o">=</span> <span class="n">fit_hrf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_bold_baseline</span>  <span class="o">=</span> <span class="n">fix_bold_baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_parameters</span>     <span class="o">=</span> <span class="n">fix_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_hrf</span>            <span class="o">=</span> <span class="n">fix_hrf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>        <span class="o">=</span> <span class="n">constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_grid</span>          <span class="o">=</span> <span class="n">save_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_grid</span>          <span class="o">=</span> <span class="n">skip_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_grid_bounds</span>    <span class="o">=</span> <span class="n">use_grid_bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>               <span class="o">=</span> <span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transpose</span>          <span class="o">=</span> <span class="n">transpose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_settings</span>      <span class="o">=</span> <span class="n">skip_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># read design matrix if needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading design matrix from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">)</span>

        <span class="c1"># read design matrix if needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading data from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>            

        <span class="c1"># adjust design matrix to data</span>
        <span class="c1"># make data 2D</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transpose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">missed_vols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># transpose if this value is negative; means shapes are shifted</span>
                <span class="k">if</span> <span class="n">missed_vols</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipped volumes was negative (</span><span class="si">{</span><span class="n">missed_vols</span><span class="si">}</span><span class="s2">), transposing data to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                    <span class="p">)</span>

                    <span class="n">missed_vols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">missed_vols</span><span class="p">:]</span>

                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Design has </span><span class="si">{</span><span class="n">missed_vols</span><span class="si">}</span><span class="s2"> more volumes than timecourses, trimming from beginning of design to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                <span class="p">)</span>

        <span class="c1">#----------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="c1"># Fetch the settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_settings</span><span class="p">()</span>

        <span class="c1"># overwrite bold baseline tuple if bold baseline should be fixed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_bold_baseline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fix_grid_baseline</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing baseline at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fix_grid_baseline</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check if we got a pRF-stim object</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Using user-defined pRF-stimulus object&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim_</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="s2">&quot;css&quot;</span><span class="p">,</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span> <span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;abd&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model specification needs to be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_models</span><span class="si">}</span><span class="s2">; got </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># sort out HRF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_hrf</span><span class="p">()</span>

        <span class="c1"># update settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_settings</span><span class="p">()</span>

        <span class="c1"># check validity of constraints</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span>
        
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using constraint(s): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="si">}</span><span class="s2"> (gauss | extended)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            
        <span class="c1">#----------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="c1"># whichever model you run, run the Gaussian first</span>

        <span class="c1">## Define models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gauss_model</span> <span class="o">=</span> <span class="n">Iso2DGaussianModel</span><span class="p">(</span><span class="n">stimulus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="p">,</span> <span class="n">hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">css_model</span> <span class="o">=</span> <span class="n">CSS_Iso2DGaussianModel</span><span class="p">(</span><span class="n">stimulus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="p">,</span> <span class="n">hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dog_model</span> <span class="o">=</span> <span class="n">DoG_Iso2DGaussianModel</span><span class="p">(</span><span class="n">stimulus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="p">,</span> <span class="n">hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">,</span> <span class="n">Norm_Iso2DGaussianModel</span><span class="p">(</span><span class="n">stimulus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="p">,</span> <span class="n">hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="si">}</span><span class="s2"> as &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_model&#39;-attribute&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_obj</span><span class="p">)</span>

<div class="viewcode-block" id="pRFmodelFitting.define_settings">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.define_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim_</span> <span class="o">=</span> <span class="n">generate_model_params</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
            <span class="n">dm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">,</span> 
            <span class="n">TR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span>
            <span class="n">fit_hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">old_settings</span><span class="o">=</span><span class="n">old_settings</span><span class="p">,</span>
            <span class="n">hrf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="pRFmodelFitting.define_hrf">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.define_hrf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">define_hrf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># make compatible with prfpy&#39;s HRF-class?</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiate HRF with: &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; (fit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="n">HRF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot use HRF-class. Please specify list of three parameters&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiate HRF with: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="si">}</span><span class="s2"> (fit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="n">HRF</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="o">.</span><span class="n">create_spm_hrf</span><span class="p">(</span><span class="n">hrf_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">,</span> <span class="n">TR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span>  
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="si">}</span><span class="s2">&#39; HRF (fit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># try to read HRF parameters from settings</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hrf_pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;hrf&#39;</span><span class="p">][</span><span class="s1">&#39;pars&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">hrf_pars</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instantiate HRF with: </span><span class="si">{</span><span class="n">hrf_pars</span><span class="si">}</span><span class="s2"> (fit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="n">HRF</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span><span class="o">.</span><span class="n">create_spm_hrf</span><span class="p">(</span><span class="n">hrf_params</span><span class="o">=</span><span class="n">hrf_pars</span><span class="p">,</span> <span class="n">TR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrf</span> <span class="o">=</span> <span class="n">hrf_pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="pRFmodelFitting.update_settings">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.update_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># overwrite settings with custom settings</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>

                <span class="c1"># hrf separate because it can be a list or object depending on prfpy-version</span>
                <span class="k">if</span> <span class="n">setting</span> <span class="o">!=</span> <span class="s2">&quot;hrf&quot;</span><span class="p">:</span>

                    <span class="c1"># only update if different</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">setting</span><span class="p">]:</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Setting &#39;</span><span class="si">{</span><span class="n">setting</span><span class="si">}</span><span class="s2">&#39; to user-defined value: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">setting</span><span class="p">)</span><span class="si">}</span><span class="s2"> (was: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">setting</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                        <span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="n">setting</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span></div>


<div class="viewcode-block" id="pRFmodelFitting.fit">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># check whether we got old parameters so we can skip Gaussian fit:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            
            <span class="c1"># agnostic read-in of existing parameter file; if pkl-file, settings will be overwritting to ensure consistency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">,</span> <span class="n">return_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_settings</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

            <span class="c1"># initiate Gaussian model</span>
            <span class="n">GaussianModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;previous_gaussian_fitter&quot;</span><span class="p">):</span>

            <span class="n">GaussianModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">GaussianModel</span><span class="o">.</span><span class="n">gridfit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1">#----------------------------------------------------------------------------------------------------------------------------------------------------------</span>
            <span class="c1"># Check if we should do Gaussian iterfit        </span>
            <span class="k">if</span> <span class="s1">&#39;iter&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">:</span>
                <span class="n">GaussianModel</span><span class="o">.</span><span class="n">iterfit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaussian fitter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># assume old parameters are grid parameters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span> <span class="ow">and</span> <span class="s2">&quot;iter&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">:</span>

                <span class="c1"># we need a separete generation of settings if we have &#39;old_params&#39; with the HRF fitted already, otherwise we get &#39;AssertionError: Unequal bounds (7) and parameters (9)&#39; because it tries to add another set of parameters for the HRF while they already exist</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>

                    <span class="c1"># HRF already fitted, so set to false and update settings</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HRF already fitted, setting &#39;fit_hrf&#39; in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="si">}</span><span class="s2">&#39; to False&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="o">.</span><span class="n">fit_hrf</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">GaussianModel</span><span class="o">.</span><span class="n">iterfit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_fitter</span>

        <span class="c1">#----------------------------------------------------------------------------------------------------------------------------------------------------------</span>
        <span class="c1"># Check if we should do DN-model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>

            <span class="c1">## Define settings/grids/fitter/bounds etcs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">define_settings</span><span class="p">(</span><span class="n">old_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_bold_baseline</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># overwrite settings with custom settings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_settings</span><span class="p">()</span>

            <span class="c1"># initiate and do grid fit</span>
            <span class="n">ExtendedModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># if existing parameters already have more than the usual parameters given a model, we assume that the HRF has been fitted</span>
            <span class="n">max_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_parameter_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_gaussian_fitter</span><span class="o">.</span><span class="n">gridsearch_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_shape</span><span class="p">:</span>

                <span class="c1"># HRF already fitted, so set to false and update settings</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HRF already fitted, setting &#39;fit_hrf&#39; in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="si">}</span><span class="s2">&#39; to False&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmp_fitter</span><span class="o">.</span><span class="n">fit_hrf</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">ExtendedModel</span><span class="o">.</span><span class="n">gridfit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;iter&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">:</span>
                <span class="n">ExtendedModel</span><span class="o">.</span><span class="n">iterfit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="pRFmodelFitting.get_max_parameter_shape">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.get_max_parameter_shape">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_max_parameter_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
            <span class="n">max_shape</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
            <span class="n">max_shape</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
            <span class="n">max_shape</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_models</span><span class="si">}</span><span class="s2">, not &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">max_shape</span></div>

    
<div class="viewcode-block" id="pRFmodelFitting.fix_hrf_parameters">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.fix_hrf_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_hrf_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bounds</span><span class="p">,</span>
        <span class="n">ref_pars</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>

        <span class="c1"># third to second to last pars = HRF (voxels, parameters)</span>
        <span class="n">hrf_pars</span> <span class="o">=</span> <span class="n">ref_pars</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># these are the indices to be set</span>
        <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># loop through data shape</span>
        <span class="n">new_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ref_pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="c1"># this means we have a list of bounds per voxel, meaning something has been fixed by `unitwise_bounds` or the input is a single time course</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="o">==</span> <span class="n">ref_pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># copy bounds if we have a single set of them</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
            
            <span class="c1"># loop through indices</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_list</span><span class="p">):</span>

                <span class="c1"># set indices to values of hrf_pars (which are 0, 1 so use enumerate)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hrf_pars</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">new_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_bounds</span></div>


<div class="viewcode-block" id="pRFmodelFitting.unitwise_bounds">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.unitwise_bounds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unitwise_bounds</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">idx_list</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_pars</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_list</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify a model from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_models</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_pars</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify an array representing parameters whose values need to be used to fix&quot;</span><span class="p">)</span>
        
        <span class="n">new_bounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ref_pars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_bounds</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">:</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ref_pars</span><span class="p">[</span><span class="n">b</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">new_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_bounds</span></div>

    
<div class="viewcode-block" id="pRFmodelFitting.fetch_optimizer_info">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.fetch_optimizer_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_optimizer_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>

        <span class="k">if</span> <span class="n">constraints</span> <span class="o">==</span> <span class="s2">&quot;tc&quot;</span><span class="p">:</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;trust-constr&quot;</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="o">==</span> <span class="s2">&quot;bgfs&quot;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;L-BFGS-B&quot;</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="o">==</span> <span class="s2">&quot;nelder&quot;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;Nelder-Mead&quot;</span>
            <span class="n">constr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown optimizer &#39;</span><span class="si">{</span><span class="n">constraints</span><span class="si">}</span><span class="s2">&#39;. Must be one of [&#39;tc&#39;, &#39;bgfs&#39;, &#39;nelder&#39;]&quot;</span><span class="p">)</span>

        <span class="n">constr_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nelder&quot;</span><span class="p">]:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xatol&quot;</span><span class="p">,</span> <span class="s2">&quot;fatol&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;powell&quot;</span><span class="p">,</span> <span class="s2">&quot;cg&quot;</span><span class="p">]:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tc&quot;</span><span class="p">]:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">,</span> <span class="s2">&quot;gtol&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bgfs&quot;</span><span class="p">]:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ftol&quot;</span><span class="p">,</span> <span class="s2">&quot;gtol&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">,</span> <span class="s2">&quot;ftol&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">constr_options</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">]</span>
                <span class="n">constr_options</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;ftol&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">constr_options</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;xtol&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constr_options</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ddict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="n">constr</span><span class="p">,</span>
            <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">constr_options</span>
        <span class="p">}</span>

        <span class="c1"># update dict with extra arguments from optimizer_kws</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;optimizer_kws&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ddict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_kwargs</span><span class="p">(</span>
                    <span class="n">ddict</span><span class="p">,</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">val</span><span class="p">,</span>
                    <span class="n">force</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ddict</span></div>


<div class="viewcode-block" id="pRFmodelFitting.fetch_bounds">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.fetch_bounds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span>                <span class="c1"># x</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span>                <span class="c1"># y</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]),</span>             <span class="c1"># prf size</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;prf_ampl&#39;</span><span class="p">]),</span>         <span class="c1"># prf amplitude</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">])</span>          <span class="c1"># bold baseline   </span>
        <span class="p">]</span>
            
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_ampl&#39;</span><span class="p">]),</span>    <span class="c1"># surround amplitude</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_size&#39;</span><span class="p">]),</span>    <span class="c1"># surround size</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;neur_bsl&#39;</span><span class="p">]),</span>     <span class="c1"># neural baseline</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_bsl&#39;</span><span class="p">])</span>      <span class="c1"># surround baseline</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;css_exponent&#39;</span><span class="p">])]</span>  <span class="c1"># CSS exponent</span>

        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_ampl&#39;</span><span class="p">]),</span>    <span class="c1"># surround amplitude</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;surr_size&#39;</span><span class="p">])</span>     <span class="c1"># surround size</span>
            <span class="p">]</span>              

        <span class="c1"># fit_hrf=False, these parameters are fixed</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">][</span><span class="s1">&#39;hrf_deriv&#39;</span><span class="p">]))</span>      <span class="c1"># HRF time derivative</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">][</span><span class="s1">&#39;hrf_disp&#39;</span><span class="p">]))</span>       <span class="c1"># HRF dispersion derivative</span>

        <span class="k">return</span> <span class="n">bounds</span></div>

    
<div class="viewcode-block" id="pRFmodelFitting.load_params">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.load_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">params_file</span><span class="p">,</span> 
        <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> 
        <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> 
        <span class="n">hemi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;load_params</span>

<span class="sd">        Attribute of `self`, with which you can load in an existing file with pRF-estimates. If the input file is a</span>
<span class="sd">        `pkl`-file, you&#39;ll get access to all the required information about your analysis: the settings, the input data, the</span>
<span class="sd">        predictions, and the design matrix. To do this, we need the `params_file` as well as information about the origin of</span>
<span class="sd">        the file; which model (e.g., `gauss`) and stage (e.g., &#39;iter&#39;) did the file arise from. We&#39;ll then internally set theparameters to the specified model and stage, making it compatible with </span>
<span class="sd">        :func:`fmriproc.prf.pRFmodelFitting.plot_vox()`. It can also be a `numpy.ndarray` or `pandas.DataFrame`, but then less</span>
<span class="sd">        information about the analysis is known. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params_file: str, dict, pandas.DataFrame, numpy.ndarray</span>
<span class="sd">            Input to load in. You&#39;ll get the most out of it when you use a `pkl`-file created with </span>
<span class="sd">            :class:`fmriproc.prf.pRFmodelFitting`, as you&#39;ll have access to the predictions, timecourses, parameters, and</span>
<span class="sd">            settings. If you do not have this, you can also enter a `numpy.ndarray` or `pandas.DataFrame`. The latter is</span>
<span class="sd">            assumed to be a result from :class:`fmriproc.prf.SizeResponse`, in that it&#39;s a *Divisive-Normalization* model</span>
<span class="sd">            result, with the following columns: `[&#39;x&#39;,&#39;y&#39;,&#39;prf_size&#39;,&#39;A&#39;,&#39;bold_bsl&#39;,&#39;B&#39;,&#39;C&#39;,&#39;surr_size&#39;,&#39;D&#39;,&#39;r2&#39;]` and indexed</span>
<span class="sd">            by `hemi` (`L`/`R`). Can also be a dictionary collecting filenames as values, and model names (e.g., &#39;gauss&#39;,</span>
<span class="sd">            &#39;norm&#39;) as keys. </span>
<span class="sd">        model: str, list optional</span>
<span class="sd">            Model from which the pRF-estimates came from, by default &#39;gauss&#39;</span>
<span class="sd">        stage: str, optional</span>
<span class="sd">            Stage from which the pRF-estimates came from, by default &#39;iter&#39;</span>
<span class="sd">        hemi: str, optional</span>
<span class="sd">            In case `params_file` is a `pandas.DataFrame` indexed by `hemi` and you want a particular subset of the dataframe</span>
<span class="sd">        return_pars: bool, optional</span>
<span class="sd">            Instead of setting the parameters as attributes given `model` and `stage`, just return the parameters as output.</span>
<span class="sd">            This will still update the settings internally if the input was a pickle-file containing the **settings** key.</span>

<span class="sd">        Raises</span>
<span class="sd">        ----------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If input is `pandas.DataFrame`, but input does not have index `hemi`</span>
<span class="sd">        ValueError</span>
<span class="sd">            If input is not one of `str`, `numpy.ndarray`, `pandas.DataFrame`</span>

<span class="sd">        Example</span>
<span class="sd">        ----------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # we initiate the model as per usual</span>
<span class="sd">            gauss_load = prf.pRFmodelFitting(</span>
<span class="sd">                data.T,</span>
<span class="sd">                design_matrix=design,</span>
<span class="sd">                TR=1.5,</span>
<span class="sd">                verbose=True)</span>

<span class="sd">            gauss_load.load_params(&quot;sub-01_ses-1_model-norm_stage-iter_desc-prf_params.pkl&quot;, model=&quot;gauss&quot;, stage=&quot;iter&quot;)</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        Also see https://fmriproc.readthedocs.io/en/latest/examples/prfmodelfitter.html</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                <span class="n">params_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">params_file</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params_file</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params_file</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">params_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">params_file</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot deal with </span><span class="si">{</span><span class="n">params_file</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">params_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">par_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params_file</span><span class="p">):</span>
            
            <span class="n">mm</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

                <span class="c1"># try to read model- from the filename</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">comps</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">split_bids_components</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">comps</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">model</span>

                <span class="k">if</span> <span class="n">par_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;npy&#39;</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">par_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pkl&#39;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                        
                    <span class="n">params</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pars&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">,</span><span class="s2">&quot;hrf&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mm</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">_predictions&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span>
                
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_settings</span><span class="p">:</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading settings from &#39;</span><span class="si">{</span><span class="n">par_file</span><span class="si">}</span><span class="s2">&#39; (safest option; overwrites other settings)&quot;</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span>

                        <span class="c1"># print important settings</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---------------------------------------------------------------------------------------------------&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Check these important updated settings!&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Screen distance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_distance_cm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">cm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Screen size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;screen_size_cm&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">cm&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; TR: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TR&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">par_file</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hemi</span><span class="p">:</span>
                    <span class="c1"># got normalization parameter file</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;prf_size&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;bold_bsl&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;surr_size&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">],</span>
                        <span class="n">par_file</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">mm</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized input type for &#39;</span><span class="si">{</span><span class="n">par_file</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_pars</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserting parameters from </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> as &#39;</span><span class="si">{</span><span class="n">mm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mm</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="pRFmodelFitting.make_predictions">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.make_predictions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vox_nr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">):</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">use_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_model&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">-object does not have attribute &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_model&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">vox_nr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vox_nr</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
                    <span class="n">vox</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vox</span> <span class="o">=</span> <span class="n">vox_nr</span>
                
                <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">vox</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">use_model</span><span class="o">.</span><span class="n">return_prediction</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vox</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">vox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">pars</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">vox</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
                    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">use_model</span><span class="o">.</span><span class="n">return_prediction</span><span class="p">(</span><span class="o">*</span><span class="n">pars</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2"> parameters for </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pRFmodelFitting.plot_vox">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.plot_vox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_vox</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">vox_nr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> 
        <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> 
        <span class="n">make_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">xkcd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">freq_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">freq_type</span><span class="o">=</span><span class="s1">&#39;fft&#39;</span><span class="p">,</span>
        <span class="n">clip_power</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save_as</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">axis_type</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="n">resize_pix</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span>
        <span class="n">n_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">add_tc</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tc&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
        <span class="n">wratios</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>    
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plot_vox</span>

<span class="sd">        Quick function to plot the pRF-location in visual space as well as the raw timecourse + prediction. This is done based</span>
<span class="sd">        on voxel-indexing, `vox_nr`. You&#39;ll need to specify the `model` and `stage` flags to select the correct pRF-estimates.</span>
<span class="sd">        If you do not want a figure, but just the outputs, you can set `make_figure=False`. Other flags are customizations,</span>
<span class="sd">        such as adding a power spectrum, font size, and xkcd-style plotting. `axis_type` refers to the nature of the x-axis.</span>
<span class="sd">        Can either be `volumes` or `time` (generally time is more informative). Finally, if you have a slightly lower</span>
<span class="sd">        resolution design matrix, you can upsample your pRF-location with a given pixel size (e.g., `270`). This is only for</span>
<span class="sd">        aesthetics in the figure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vox_nr: int, np.ndarray, optional</span>
<span class="sd">            Voxel/vertex index to create the plot for, by default 0. Can also be a 1D array</span>
<span class="sd">        model: str, optional</span>
<span class="sd">            Which *model* to select the pRF-estimates from, by default &#39;gauss&#39;</span>
<span class="sd">        stage: str, optional</span>
<span class="sd">            Which *stage* to select the pRF-estimates from, by default &#39;iter&#39;</span>
<span class="sd">        make_figure: bool, optional</span>
<span class="sd">            Make the figure (`make_figure=True`) and output `params`, the `np.ndarray` representing the pRF in visual space,</span>
<span class="sd">            the BOLD timecourse, and the `prediction`; or `make_figure=False` and only return `params` and `prediction`, by</span>
<span class="sd">            default True</span>
<span class="sd">        xkcd: bool, optional</span>
<span class="sd">            Make the plot in xkcd-style, by default False</span>
<span class="sd">        title: str, optional</span>
<span class="sd">            Title of the timecourse plot. If `title=&#39;pars&#39;`, we&#39;ll set the parameters as title. This can be useful to quickly</span>
<span class="sd">            check parameters, by default None</span>
<span class="sd">        font_size: int, optional</span>
<span class="sd">            Fontsize for x/y-labels and title, by default 18</span>
<span class="sd">        transpose: bool, optional</span>
<span class="sd">            Depending on how the predictions are loaded, you might need to transpose. Generally, if you&#39;ve ran the fitting</span>
<span class="sd">            before plotting, this should be fine. Rule of thumb: if you get an indexing error, try `transpose=True`.</span>
<span class="sd">        freq_spectrum: bool, optional</span>
<span class="sd">            Add a frequency spectrum of the timecourse, by default False</span>
<span class="sd">        freq_type: str, optional</span>
<span class="sd">            Which type of frequency sprectrum, by default &#39;fft&#39; (see also :func:`lazyfmri.preproc.get_freq`</span>
<span class="sd">        clip_power: int, optional</span>
<span class="sd">            Clip the power of the spectrum to enhance visualization, by default None</span>
<span class="sd">        save_as: str, optional</span>
<span class="sd">            Save the figure as `save_as`, by default None</span>
<span class="sd">        axis_type: str, optional</span>
<span class="sd">            Type of x-axis, by default &quot;volumes&quot;. Can also be &#39;time&#39; to use time-dimension, rather than volume-dimension</span>
<span class="sd">        resize_pix: int, optional</span>
<span class="sd">            Spatially smooth your pRF if you&#39;ve used a low-resolution design matrix, by default None. Generally,</span>
<span class="sd">            `resize_pix=270` results in pleasing pRF-depictions</span>
<span class="sd">        add_tc: dict, np.ndarray, optional</span>
<span class="sd">            Allows an additional timecourse to be plotted with the data and the prediction. Can be either a numpy array or a</span>
<span class="sd">            dictionary with the following keys:</span>

<span class="sd">            - &quot;tc&quot;: the timecourse to add. If `add_tc == np.ndarray`, then &quot;tc&quot; will be set internally</span>
<span class="sd">            - &quot;color&quot;: any valid `matplotlib`-color (e.g., RGB/Hex). Default = &quot;b&quot;</span>
<span class="sd">            - &quot;lw&quot;: line width of the timecourse. Default = 2</span>
<span class="sd">            - &quot;marker&quot;: marker type of the timecourse. Default = None</span>
<span class="sd">            - &quot;label&quot;: label to add to the legend. Default = &quot;extra&quot;</span>

<span class="sd">            Some examples:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                add_tc=np.array([]) # simplest</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # set some extra options</span>
<span class="sd">                add_tc={</span>
<span class="sd">                    &quot;tc&quot;: np.array([]),</span>
<span class="sd">                    &quot;label&quot;: &quot;grid&quot;,</span>
<span class="sd">                    &quot;marker&quot;: &quot;.&quot;</span>
<span class="sd">                }</span>

<span class="sd">        normalize: bool, optional</span>
<span class="sd">        Normalize the prediction to the max amplitude. Default = False</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            1D-array representing the parameters of you selected voxel</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            2D-array representing the pRF of your selected voxel in visual space</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            1D-array representing the raw BOLD timecourse of your selected voxel</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            1D-array representing the prediction of your selected voxel given `model`, `stage`, and `voxel`</span>

<span class="sd">        Example</span>
<span class="sd">        ----------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from fmriproc.prf import pRFmodelFitting</span>
<span class="sd">            </span>
<span class="sd">            # define the model</span>
<span class="sd">            fitting = pRFmodelFitting(func, design_matrix=dm, model=&#39;gauss&#39;)</span>

<span class="sd">            # fit</span>
<span class="sd">            fitting.fit()</span>
<span class="sd">            </span>
<span class="sd">            # plot the 1st voxel</span>
<span class="sd">            fitting.plot_vox(</span>
<span class="sd">                vox_nr=0,</span>
<span class="sd">                title=&#39;pars&#39;,</span>
<span class="sd">                model=&#39;gauss&#39;,</span>
<span class="sd">                stage=&#39;iter&#39;</span>
<span class="sd">            )</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        - To silence output, use:</span>
<span class="sd">        </span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">            </span>
<span class="sd">                _= fitting.plot_vox()</span>

<span class="sd">        - Also check https://fmriproc.readthedocs.io/en/latest/examples/prfmodelfitter.html for more examples</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vox_nr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vox_nr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vox_nr</span> <span class="o">=</span> <span class="n">vox_nr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Array of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">vox_nr</span><span class="p">)</span><span class="si">}</span><span class="s2"> was given. Can only be 1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_predictions</span><span class="p">(</span>
            <span class="n">vox_nr</span><span class="o">=</span><span class="n">vox_nr</span><span class="p">,</span> 
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> 
            <span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">_predictions&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">_predictions&quot;</span><span class="p">)[</span><span class="n">vox_nr</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
        <span class="n">prf_array</span> <span class="o">=</span> <span class="n">make_prf</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="p">,</span> 
            <span class="n">params</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="c1"># size=params[2], </span>
            <span class="c1"># mu_x=params[0], </span>
            <span class="c1"># mu_y=params[1], </span>
            <span class="n">resize_pix</span><span class="o">=</span><span class="n">resize_pix</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="c1"># annoying indexing issues.. lots of inconsistencies in array shapes.</span>
                <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">vox</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vox</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

                <span class="c1"># set default lists</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">]</span>
                <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
                <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;real&#39;</span><span class="p">,</span> <span class="s1">&#39;pred&#39;</span><span class="p">]</span>
                <span class="n">lw_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">marker_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="p">]</span>
                <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
                <span class="n">label_list</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">lw_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">marker_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">make_figure</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">freq_spectrum</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wratios</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">wratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>

                    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">wratios</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wratios</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">wratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>

                    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">wratios</span><span class="p">)</span>

                <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># make plot </span>
            <span class="n">cross_col</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
                <span class="n">cross_col</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>

            <span class="n">plotting</span><span class="o">.</span><span class="n">LazyPRF</span><span class="p">(</span>
                <span class="n">prf_array</span><span class="p">,</span> 
                <span class="n">cross_color</span><span class="o">=</span><span class="n">cross_col</span><span class="p">,</span>
                <span class="n">vf_extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;vf_extent&#39;</span><span class="p">],</span> 
                <span class="n">axs</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> 
                <span class="n">xkcd</span><span class="o">=</span><span class="n">xkcd</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># make plot </span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;pars&quot;</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">params</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">axis_type</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;time (s)&quot;</span>
                <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;volumes&quot;</span>
            
            <span class="k">if</span> <span class="s2">&quot;x_label&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">x_label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;x_label&quot;</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;x_label&quot;</span><span class="p">)</span>
            
            <span class="c1"># add additional timecourse</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_tc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">add_tc</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tc&quot;</span><span class="p">:</span> <span class="n">add_tc</span><span class="p">}</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_tc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_tc</span><span class="p">[</span><span class="s2">&quot;tc&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">default_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;extra&quot;</span><span class="p">}</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">default_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_tc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="n">add_tc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">ll</span><span class="p">,</span><span class="n">it</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">data_list</span><span class="p">,</span><span class="n">color_list</span><span class="p">,</span><span class="n">label_list</span><span class="p">,</span><span class="n">lw_list</span><span class="p">,</span><span class="n">marker_list</span><span class="p">],</span>
                        <span class="p">[</span><span class="s2">&quot;tc&quot;</span><span class="p">,</span><span class="s2">&quot;color&quot;</span><span class="p">,</span><span class="s2">&quot;label&quot;</span><span class="p">,</span><span class="s2">&quot;lw&quot;</span><span class="p">,</span><span class="s2">&quot;marker&quot;</span><span class="p">]):</span>

                        <span class="n">ll</span> <span class="o">+=</span> <span class="p">[</span><span class="n">add_tc</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span>

            <span class="n">diff</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="n">diff</span><span class="o">/</span><span class="n">n_time</span>

            <span class="n">x_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">x_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">x_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                <span class="n">num</span><span class="o">=</span><span class="n">n_time</span><span class="p">,</span> 
                <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">force_int</span><span class="p">:</span>
                <span class="n">x_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_ticks</span><span class="p">]</span>

            <span class="n">ddict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x_ticks&quot;</span><span class="p">:</span> <span class="n">x_ticks</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">ddict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_kwargs</span><span class="p">(</span>
                    <span class="n">kwargs</span><span class="p">,</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">val</span>
                <span class="p">)</span>

            <span class="n">plotting</span><span class="o">.</span><span class="n">LazyLine</span><span class="p">(</span>
                <span class="n">data_list</span><span class="p">,</span>
                <span class="n">xx</span><span class="o">=</span><span class="n">x_axis</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color_list</span><span class="p">,</span> 
                <span class="n">labels</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span> 
                <span class="n">add_hline</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">x_label</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span>
                <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;amplitude&quot;</span><span class="p">,</span>
                <span class="n">axs</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">xkcd</span><span class="o">=</span><span class="n">xkcd</span><span class="p">,</span>
                <span class="n">line_width</span><span class="o">=</span><span class="n">lw_list</span><span class="p">,</span>
                <span class="n">markers</span><span class="o">=</span><span class="n">marker_list</span><span class="p">,</span>
                <span class="c1"># x_lim=[0,x_axis.shape[0]],</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">freq_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need an extra axis in the list for this function&quot;</span><span class="p">)</span>
                    
                    <span class="n">ax3</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">preproc</span><span class="o">.</span><span class="n">get_freq</span><span class="p">(</span>
                    <span class="n">tc</span><span class="p">,</span> 
                    <span class="n">TR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span> 
                    <span class="n">spectrum_type</span><span class="o">=</span><span class="n">freq_type</span><span class="p">,</span> 
                    <span class="n">clip_power</span><span class="o">=</span><span class="n">clip_power</span>
                <span class="p">)</span>

                <span class="n">plotting</span><span class="o">.</span><span class="n">LazyLine</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">xx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#1B9E77&quot;</span><span class="p">,</span> 
                    <span class="n">x_label</span><span class="o">=</span><span class="s2">&quot;frequency (Hz)&quot;</span><span class="p">,</span>
                    <span class="n">y_label</span><span class="o">=</span><span class="s2">&quot;power (a.u.)&quot;</span><span class="p">,</span>
                    <span class="n">axs</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">freq_type</span><span class="p">,</span>
                    <span class="n">xkcd</span><span class="o">=</span><span class="n">xkcd</span><span class="p">,</span>
                    <span class="n">x_lim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span>
                    <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_as</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="n">save_as</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">save_as</span><span class="p">,</span> 
                    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">prf_array</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction</span></div>


<div class="viewcode-block" id="pRFmodelFitting.save_params">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.pRFmodelFitting.save_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> 
        <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span>
        <span class="n">output_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            
            <span class="c1"># set output stuff</span>
            <span class="k">for</span> <span class="n">flag</span><span class="p">,</span><span class="n">el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">output_base</span><span class="p">,</span><span class="n">output_dir</span><span class="p">],[</span><span class="s2">&quot;output_base&quot;</span><span class="p">,</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">el</span><span class="si">}</span><span class="s2">&#39; is not set. Use the flags in &#39;save_params&#39; or define in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># define pickle</span>
            <span class="n">pkl_file</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_base</span><span class="si">}</span><span class="s1">_model-</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_stage-</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">_desc-prf_params.pkl&#39;</span><span class="p">)</span>

            <span class="c1"># get parameters given model and stage</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># write a pickle-file with relevant outputs</span>
            <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;pars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span>
            <span class="c1"># out_dict[&#39;predictions&#39;] = self.make_predictions(model=model, stage=stage)</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Save </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">-fit parameters in </span><span class="si">{</span><span class="n">pkl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> does not have attribute &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&#39;. Not saving parameters&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="find_most_similar_prf">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.find_most_similar_prf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_most_similar_prf</span><span class="p">(</span><span class="n">reference_prf</span><span class="p">,</span> <span class="n">look_in_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_nr</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">r2_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;find_most_similar_prf</span>

<span class="sd">    find a pRF with similar characteristics in one array given the specifications of another pRF</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference_prf: numpy.ndarray</span>
<span class="sd">        pRF-parameters from the reference pRF, where `reference_prf[0]` = **x**, `reference_prf[1]` = **y**, and </span>
<span class="sd">        `reference_prf[2]` = **size**</span>
<span class="sd">    look_in_params: numpy.ndarray</span>
<span class="sd">        array of pRF-parameters in which we will be looking for `reference_prf`</span>
<span class="sd">    verbose: bool, optional</span>
<span class="sd">        Set to True if you want some messages along the way (default = False)</span>
<span class="sd">    return_nr: str, int</span>
<span class="sd">        same parameter as in :func:`lazyfmri.utils.find_nearest`, where we can specify how many matches we want to have</span>
<span class="sd">        returned (default = &quot;all&quot;) </span>
<span class="sd">    r2_thresh: float</span>
<span class="sd">        after finding matching pRF, throw away fits below `r2_thresh`</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        array containing the indices of `look_in_params` that conform the search</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_par</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">look_in_params</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">reference_prf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_nr</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_par</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> survived x-parameter matching&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="n">y_par</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">look_in_params</span><span class="p">[</span><span class="n">x_par</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">reference_prf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_nr</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">xy_par</span> <span class="o">=</span> <span class="n">x_par</span><span class="p">[</span><span class="n">y_par</span><span class="p">]</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xy_par</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> survived y-parameter matching&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="n">size_par</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">look_in_params</span><span class="p">[</span><span class="n">xy_par</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">reference_prf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">return_nr</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="n">xysize_par</span> <span class="o">=</span> <span class="n">xy_par</span><span class="p">[</span><span class="n">size_par</span><span class="p">]</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xysize_par</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> survived size-parameter matching&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># filter indices with r2</span>
    <span class="k">if</span> <span class="n">r2_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">look_in_params</span><span class="p">[</span><span class="n">xysize_par</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">r2_thresh</span>
        <span class="n">true_idc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">filt</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">xysize_par</span> <span class="o">=</span> <span class="n">xysize_par</span><span class="p">[</span><span class="n">true_idc</span><span class="p">]</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xysize_par</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> survived r2&gt;</span><span class="si">{</span><span class="n">r2_thresh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xysize_par</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find similar pRFs. Maybe lower r2-threshold?&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">return_nr</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xysize_par</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xysize_par</span><span class="p">[:</span><span class="n">return_nr</span><span class="p">]</span></div>



<div class="viewcode-block" id="SizeResponse">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SizeResponse</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SizeResponse</span>

<span class="sd">    Perform size-response related operations given a pRF-stimulus/parameters. Simulate the pRF-response using a set of growing</span>
<span class="sd">    stimuli (or growing holes) using :func:`fmriproc.prf.make_stims`, create size/hole response functions, and find stimulus</span>
<span class="sd">    sizes that maximize activation and suppression.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params: numpy.ndarray, str, pd.DataFrame</span>
<span class="sd">        Output of a Divisive Normalization fit </span>
<span class="sd">    prf_stim: :class:`prfpy.stimulus.PRFStimulus2D`</span>
<span class="sd">        Object describing the nature of the stimulus</span>
<span class="sd">    subject_info: :class:`fmriproc.prf.VertexInfo`-object</span>
<span class="sd">        Subject information collected in :class:`fmriproc.prf.VertexInfo` that can be used for </span>
<span class="sd">        :func:`fmriproc.prf.SizeResponse.save_target_params`</span>
<span class="sd">    model: str, optional</span>
<span class="sd">        Model from which `params` is derived. Default = &quot;norm&quot;</span>
<span class="sd">    subject_info: :class:`fmriproc.prf.CollectSubject`, optional</span>
<span class="sd">        Object collection defaults given a subject. Mainly used to generate the `prf_stim` object, which is used to derive</span>
<span class="sd">        information about screen settings, which can also be set with the flags below. Therefore, not mandatory.</span>
<span class="sd">    downsample_factor: int, optional</span>
<span class="sd">        The default screen is [1920,1080]. This is rather large and can be complicated CPU wise. This flag downsamples the</span>
<span class="sd">        screen size by selecting every `downsample_factor` along the x and y axis</span>
<span class="sd">    n_pix: int, optional</span>
<span class="sd">        Number of pixels in the design matrix to simulate (smaller is faster)</span>
<span class="sd">    screen_distance_cm: int, optional</span>
<span class="sd">        Distance from viewer to screen. Default is the MRI-scanner value of 196 cm</span>
<span class="sd">    screen_size_cm: float, tuple, list, optional</span>
<span class="sd">        Dimensions of the screen in **centimeters**. Default is the BOLD screen: [70,39.3]. Specify a single value to create</span>
<span class="sd">        square stimuli</span>
<span class="sd">    screen_size_px: float, tuple, list, optional</span>
<span class="sd">        Dimensions of the screen in **pixels**. Default is the BOLD screen: [1920,1080]. Specify a single value to create</span>
<span class="sd">        square stimuli</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from fmriproc import prf</span>
<span class="sd">        # define file with pRF estimates</span>
<span class="sd">        in_file = &quot;sub-01_ses-1_task-2R_model-norm_stage-iter_desc-prf_params.pkl&quot;</span>
<span class="sd">        #</span>
<span class="sd">        # read the input file into a dataframe</span>
<span class="sd">        df_for_srfs = prf.Parameters(in_file, model=&quot;norm&quot;).to_df()</span>
<span class="sd">        #</span>
<span class="sd">        # initialize class</span>
<span class="sd">        SR_ = prf.SizeResponse(</span>
<span class="sd">            params=df_for_srfs,</span>
<span class="sd">            model=&quot;norm&quot;,</span>
<span class="sd">            screen_distance_cm=196,</span>
<span class="sd">            screen_size_cm=[70,39.3],</span>
<span class="sd">            screen_size_px=[1920,1080])</span>
<span class="sd">    </span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        from lazyfmri import utils</span>
<span class="sd">        # Collect subject-relevant information in class</span>
<span class="sd">        subject = &quot;sub-001&quot;</span>
<span class="sd">        hemi = &quot;lh&quot;</span>
<span class="sd">        #</span>
<span class="sd">        if hemi == &quot;lh&quot;:</span>
<span class="sd">            hemi_tag = &quot;hemi-L&quot;</span>
<span class="sd">        elif hemi == &quot;rh&quot;:</span>
<span class="sd">            hemi_tag = &quot;hemi-R&quot;</span>
<span class="sd">        #</span>
<span class="sd">        subject_info = prf.CollectSubject(</span>
<span class="sd">            subject, </span>
<span class="sd">            prf_dir=prf_dir, </span>
<span class="sd">            cx_dir=cx_dir, </span>
<span class="sd">            hemi=hemi, </span>
<span class="sd">            resize_pix=270,</span>
<span class="sd">            verbose=False)</span>
<span class="sd">        #</span>
<span class="sd">        # Get and plot fMRI signal</span>
<span class="sd">        data_fn = utils.get_file_from_substring(f&quot;avg_bold_{hemi_tag}.npy&quot;, subject_info.prfdir)</span>
<span class="sd">        data = np.load(data_fn)[...,subject_info.return_target_vertex(hemi=hemi)]</span>
<span class="sd">        #</span>
<span class="sd">        # insert old parameters</span>
<span class="sd">        insert_params = subject_info.target_params</span>
<span class="sd">        #</span>
<span class="sd">        # initiate class</span>
<span class="sd">        fitting = prf.pRFmodelFitting(</span>
<span class="sd">            data[...,np.newaxis].T, </span>
<span class="sd">            design_matrix=subject_info.design_matrix, </span>
<span class="sd">            TR=subject_info.settings[&#39;TR&#39;], </span>
<span class="sd">            model=&quot;norm&quot;, </span>
<span class="sd">            stage=&quot;grid&quot;, </span>
<span class="sd">            old_params=insert_params, </span>
<span class="sd">            verbose=False, </span>
<span class="sd">            output_dir=subject_info.prfdir, </span>
<span class="sd">            nr_jobs=1)</span>
<span class="sd">        #</span>
<span class="sd">        # fit</span>
<span class="sd">        fitting.fit()</span>
<span class="sd">        #</span>
<span class="sd">        new_params = fitting.norm_grid[0]</span>
<span class="sd">        #</span>
<span class="sd">        # size response functions</span>
<span class="sd">        SR = prf.SizeResponse(fitting.prf_stim, new_params)</span>

<span class="sd">        # add subject info object</span>
<span class="sd">        SR = prf.SizeResponse(fitting.prf_stim, new_params, subject_info=subject_info)        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">prf_stim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> 
        <span class="n">subject_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">downsample_factor</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">n_pix</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">screen_distance_cm</span><span class="o">=</span><span class="mi">196</span><span class="p">,</span>
        <span class="n">screen_size_cm</span><span class="o">=</span><span class="p">[</span><span class="mi">70</span><span class="p">,</span><span class="mf">39.3</span><span class="p">],</span>
        <span class="n">screen_size_px</span><span class="o">=</span><span class="p">[</span><span class="mi">1920</span><span class="p">,</span><span class="mi">1080</span><span class="p">],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span> <span class="o">=</span> <span class="n">prf_stim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span> <span class="o">=</span> <span class="n">subject_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">downsample_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span> <span class="o">=</span> <span class="n">n_pix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_distance_cm</span> <span class="o">=</span> <span class="n">screen_distance_cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_size_cm</span> <span class="o">=</span> <span class="n">screen_size_cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen_size_px</span> <span class="o">=</span> <span class="n">screen_size_px</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># overwrite info in CollectSubject object was specified</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="p">,</span> <span class="n">CollectSubject</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="o">.</span><span class="n">prf_stim</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="o">.</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen_distance_cm</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="o">.</span><span class="n">screen_distance_cm</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="o">.</span><span class="n">screen_distance_cm</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen_size_cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_stim</span><span class="o">.</span><span class="n">screen_size_cm</span>
            
            <span class="c1"># overwrite verbose-flag from CollectSubject</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_df</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># parse potential floats into list</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;screen_size_cm&quot;</span><span class="p">,</span> <span class="s2">&quot;screen_size_px&quot;</span><span class="p">]:</span>
            <span class="n">el</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="p">[</span><span class="n">el</span><span class="p">,</span><span class="n">el</span><span class="p">])</span>

        <span class="c1"># define visual field in degree of visual angle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen_size_cm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">screen_distance_cm</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_size_px</span><span class="p">[</span><span class="mi">0</span><span class="p">])[::</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen_size_cm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">screen_distance_cm</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen_size_px</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># define visual extent:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_ext</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_x</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_ext</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_deg_y</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vf_extent</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_ext</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ext</span><span class="p">)</span>
    
<div class="viewcode-block" id="SizeResponse.make_stimuli">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.make_stimuli">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_stimuli</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">factor</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
        <span class="n">dt</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> 
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;create stimuli for Size-Response curve simulation. See :func:`fmriproc.prf.make_stims`&quot;&quot;&quot;</span>
        <span class="c1"># create stimuli</span>
        
        <span class="n">stims</span><span class="p">,</span> <span class="n">sizes</span> <span class="o">=</span> <span class="n">make_stims</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> 
            <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> 
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">stims</span><span class="p">,</span><span class="n">sizes</span></div>


<div class="viewcode-block" id="SizeResponse.find_pref_size">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.find_pref_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_pref_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;stims_fill&quot;</span><span class="p">):</span>
            <span class="n">stims</span><span class="p">,</span> <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_stimuli</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">idx</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span><span class="p">,</span><span class="n">sizes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="SizeResponse.make_sr_function">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.make_sr_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_sr_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">params</span><span class="p">,</span> 
        <span class="n">stims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">center_prf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>

        <span class="c1"># get x,y,size parameters</span>
        <span class="k">if</span> <span class="n">center_prf</span><span class="p">:</span>
            <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mu_x</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
            <span class="n">mu_y</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">mu_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mu_x</span> <span class="o">=</span> <span class="n">mu_x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">mu_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mu_y</span> <span class="o">=</span> <span class="n">mu_y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>            

        <span class="n">sr</span> <span class="o">=</span> <span class="n">norm_2d_sr_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">params</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">params</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">params</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">params</span><span class="o">.</span><span class="n">D</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">params</span><span class="o">.</span><span class="n">prf_size</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">params</span><span class="o">.</span><span class="n">surr_size</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
            <span class="n">stims</span><span class="p">,</span> 
            <span class="n">mu_x</span><span class="o">=</span><span class="n">mu_x</span><span class="p">,</span> 
            <span class="n">mu_y</span><span class="o">=</span><span class="n">mu_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">sr</span> <span class="o">/=</span> <span class="n">sr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">sr</span></div>


<div class="viewcode-block" id="SizeResponse.batch_sr_function">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.batch_sr_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch_sr_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">center_prf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">normalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">stims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">thresh</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">max_jobs</span><span class="o">=</span><span class="mi">20</span>
        <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;create Size-Response function. If you want to ignore the actual location of the pRF, set `center_prf=True`. You can</span>
<span class="sd">        also scale the pRF-size with a factor `scale_factor`, for instance if you want to simulate pRF-sizes across depth.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
        
        <span class="c1"># reset indices, but keep vertex IDs</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># get indices where prf size != 0</span>
        <span class="n">idc_valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">prf_size</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">idc_valid</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> vertices &gt; </span><span class="si">{</span><span class="n">thresh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># filter out zeros</span>
        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idc_valid</span><span class="p">]]</span>
                
        <span class="c1"># use batches</span>
        <span class="k">if</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="n">center_prf</span><span class="p">:</span>
            
            <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">batch_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_batches</span> <span class="o">&gt;</span> <span class="n">max_jobs</span><span class="p">:</span>
                    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">max_jobs</span>
                    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">n_batches</span><span class="p">))</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Split data in </span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2"> batches of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> vertices&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># parse dataframe into list of batch dataframes for parallellization</span>
            <span class="n">act</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">df_batches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">batch_size</span><span class="p">)</span><span class="o">+</span><span class="n">batch_size</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_batch</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">act</span><span class="p">:</span><span class="n">interval</span><span class="p">,:]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">df_batch</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">act</span><span class="p">:,:]</span>

                <span class="n">df_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_batch</span><span class="p">)</span>
                <span class="n">act</span> <span class="o">+=</span> <span class="n">batch_size</span>

            <span class="c1"># loop through dfs</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Running parallel jobs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_batches</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_sr_function</span><span class="p">)(</span>
                    <span class="n">batch</span><span class="p">,</span> 
                    <span class="n">stims</span><span class="o">=</span><span class="n">stims</span><span class="p">,</span>
                    <span class="n">center_prf</span><span class="o">=</span><span class="n">center_prf</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">df_batches</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Running serial jobs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

                <span class="c1"># use same stimulus sequence for all pRFs</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_batches</span><span class="p">):</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sr_function</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">stims</span><span class="o">=</span><span class="n">stims</span><span class="p">)</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;batch #</span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> | process took </span><span class="si">{</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                    <span class="n">dd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="c1"># concatenate into single array</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">/=</span> <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">n_stims</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># make single SR function</span>
            <span class="k">if</span> <span class="n">center_prf</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sr_function</span><span class="p">(</span>
                    <span class="n">df_filtered</span><span class="p">,</span>
                    <span class="n">stims</span><span class="o">=</span><span class="n">stims</span><span class="p">,</span>
                    <span class="n">center_prf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">n_stims</span> <span class="o">=</span> <span class="n">stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># custom stimuli for each pRF</span>
                <span class="n">func</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating unique stimulus (type=&#39;</span><span class="si">{</span><span class="n">stims</span><span class="si">}</span><span class="s2">&#39;) set for each pRF&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">collect_stims</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">rf_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    
                    <span class="c1"># get parameters</span>
                    <span class="n">rf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rf_ix</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

                    <span class="c1"># make stimulus</span>
                    <span class="n">rf_stims</span><span class="p">,</span><span class="n">rf_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_stimuli</span><span class="p">(</span>
                        <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">dt</span><span class="o">=</span><span class="n">stims</span><span class="p">,</span> 
                        <span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rf</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                    <span class="n">collect_stims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_stims</span><span class="p">)</span>
                    <span class="n">n_stims</span> <span class="o">=</span> <span class="n">rf_stims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="c1"># get srf</span>
                    <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_sr_function</span><span class="p">(</span>
                        <span class="n">rf</span><span class="p">,</span> 
                        <span class="n">stims</span><span class="o">=</span><span class="n">rf_stims</span><span class="p">,</span>
                        <span class="n">center_prf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    
                    <span class="n">func</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>

                <span class="n">stims</span> <span class="o">=</span> <span class="n">rf_stims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="n">rf_sizes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">/=</span> <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># initialize empty output array</span>
        <span class="n">srf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_stims</span><span class="p">))</span>
        <span class="n">srf</span><span class="p">[</span><span class="n">idc_valid</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">func</span>

        <span class="n">df_srf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">srf</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">df_srf</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">],</span><span class="n">df_srf</span><span class="p">[</span><span class="s2">&quot;stim_nr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df_srf</span></div>


<div class="viewcode-block" id="SizeResponse.find_stim_sizes">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.find_stim_sizes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_stim_sizes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">curve1</span><span class="p">,</span> 
        <span class="n">curve2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">t</span><span class="o">=</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> 
        <span class="n">dt</span><span class="o">=</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span>
        <span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">return_ampl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;find_stim_sizes</span>

<span class="sd">        Function to fetch the stimulus sizes that optimally disentangle the responses of two pRFs given the Size-Response</span>
<span class="sd">        curves. Starts by finding the maximum response for each curve, then finds the intersect, then finds the stimulus sizes</span>
<span class="sd">        before and after the intersect where the response difference is largest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curve1: numpy.ndarray</span>
<span class="sd">            Array representing the first SR-curve (as per output for :func:`fmriproc.prf.SizeResponse.make_sr_function`)</span>
<span class="sd">        curve2: numpy.ndarray</span>
<span class="sd">            Array representing the second SR-curve (as per output for :func:`fmriproc.prf.SizeResponse.make_sr_function`)</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            array containing the optimal stimulus sizes as per :func:`fmriproc.prf.SizeResponse.make_stims`</span>

<span class="sd">        Example</span>
<span class="sd">        ----------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # follows up on example in *fmriproc.prf.SizeResponse*</span>
<span class="sd">            SR.make_stimuli()</span>
<span class="sd">            sr_curve1 = SR.make_sr_function(center_prf=True)</span>
<span class="sd">            sr_curve2 = SR.make_sr_function(center_prf=True, scale_factor=0.8) # decrease pRF size of second pRF by 20%</span>
<span class="sd">            use_stim_sizes = SR.find_stim_sizes(sr_curve1, sr_curve2)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find the peaks of individual curves</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curve2</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>

            <span class="c1"># do some formatting stuff</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curve2</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">curve2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curve2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">curve2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">curve2</span> <span class="o">=</span> <span class="n">curve2</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">curve1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">curve1</span> <span class="o">=</span> <span class="n">curve1</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;sizes must be a list or array consisting of stimulus sizes, not </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s2"> of type</span>
<span class="s2">                                 (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># get intersection</span>
            <span class="n">sr_diff</span> <span class="o">=</span> <span class="n">curve1</span><span class="o">-</span><span class="n">curve2</span>
            <span class="n">size_indices</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">sr_diff</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># append sizes of max of curves</span>
            <span class="n">use_stim_sizes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">size_index</span> <span class="ow">in</span> <span class="n">size_indices</span><span class="p">:</span>
                <span class="n">use_stim_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">size_index</span><span class="p">])</span>

            <span class="c1"># # find intersection of curves</span>
            <span class="n">y_size</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_intersection</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">curve1</span><span class="p">,</span> <span class="n">curve2</span><span class="p">)</span>
            <span class="n">use_stim_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_size</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">use_stim_sizes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c1"># find equidistance </span>
            <span class="n">eq1</span> <span class="o">=</span> <span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">eq2</span> <span class="o">=</span> <span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">use_stim_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

            <span class="n">use_stim_sizes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">eq1</span><span class="p">,</span><span class="n">eq2</span><span class="p">]</span>
            <span class="n">use_stim_sizes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">use_stim_sizes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># find maximum</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="n">ffunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ffunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span>

            <span class="n">max_idx</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">max_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">extr_val</span> <span class="o">=</span> <span class="n">ffunc</span><span class="p">(</span><span class="n">curve1</span><span class="p">[:</span><span class="n">max_idx</span><span class="p">])</span>
            <span class="n">size_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">curve1</span><span class="p">[:</span><span class="n">max_idx</span><span class="p">]</span><span class="o">==</span><span class="n">extr_val</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;stims_</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">_sizes&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_ampl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sizes</span><span class="p">[</span><span class="n">size_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sizes</span><span class="p">[</span><span class="n">size_index</span><span class="p">],</span><span class="n">extr_val</span></div>


<div class="viewcode-block" id="SizeResponse.plot_stim_size">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.plot_stim_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_stim_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">stim</span><span class="p">,</span> 
        <span class="n">vf_extent</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]),</span> 
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">cmap</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">178</span><span class="p">,</span><span class="mi">240</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plot output of :func:`fmriproc.prf.SizeResponse.find_stim_sizes`&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>        
        
        <span class="n">cmap_blue</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_binary_cm</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">stim</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="n">vf_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">vf_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_blue</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">axis</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clip</span><span class="p">:</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="n">vf_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">set_clip_path</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span></div>


<div class="viewcode-block" id="SizeResponse.save_target_params">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.SizeResponse.save_target_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_target_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> 
        <span class="n">stim_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write best_vertices-type file for normalization parameters + full normalization parameters in numpy-file&quot;&quot;&quot;</span>
            
        <span class="k">if</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s2">&quot;lh&quot;</span><span class="p">:</span>
            <span class="n">hemi</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span>
        <span class="k">elif</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s2">&quot;rh&quot;</span><span class="p">:</span>
            <span class="n">hemi</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prf_bestvertex</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="o">.</span><span class="n">cx_dir</span><span class="p">,</span> 
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s1">_model-norm_desc-best_vertices.csv&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prf_bestvertex</span> <span class="o">=</span> <span class="n">fname</span>

            <span class="c1"># write existing pRF parameters to dictionary</span>
            <span class="n">vert_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_info</span><span class="o">.</span><span class="n">vert_info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;hemi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">hemi</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params_df</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

            <span class="c1"># add custom stuff</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="s2">&quot;position&quot;</span><span class="p">,</span><span class="s2">&quot;normal&quot;</span><span class="p">]:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">vert_info</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

            <span class="c1"># add stim sizes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim_sizes</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
                <span class="n">stim_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_sizes</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stim_sizes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;stim_sizes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stim_sizes</span><span class="p">)</span>
                            
            <span class="c1"># append to existing file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prf_bestvertex</span><span class="p">):</span>

                <span class="c1"># can index an indexed dataframe</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">prf_bestvertex</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;hemi&quot;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">prf_bestvertex</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;stim_sizes&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stim_sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stim_sizes&quot;</span><span class="p">][</span><span class="n">hemi</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;stim_sizes&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>

            <span class="c1"># can index an indexed dataframe</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;hemi&quot;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prf_bestvertex</span><span class="p">)</span></div>
</div>

        
        <span class="c1"># # save full parameters as well</span>
        <span class="c1"># pars_file = opj(self.subject_info.cx_dir, f&#39;{self.subject_info.subject}_model-norm_desc-params.csv&#39;) </span>
        <span class="c1"># self.params_df[&#39;hemi&#39;] = hemi</span>
        <span class="c1"># if os.path.exists(pars_file):</span>
        <span class="c1">#     tmp = pd.read_csv(pars_file).reset_index()</span>

        <span class="c1">#     if hemi in tmp[&#39;hemi&#39;].values:</span>
        <span class="c1">#         tmp = tmp[tmp.hemi != hemi]</span>

        <span class="c1">#     self.params_df = pd.concat((self.params_df, tmp))</span>

        <span class="c1"># self.params_df.set_index(&#39;hemi&#39;).to_csv(pars_file)</span>

<div class="viewcode-block" id="CollectSubject">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.CollectSubject">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CollectSubject</span><span class="p">(</span><span class="n">pRFmodelFitting</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CollectSubject</span>

<span class="sd">    Simple class to fetch pRF-related settings given a subject. Collects the design matrix, settings, and target vertex</span>
<span class="sd">    information. The `ses`-flag decides from which session the pRF-parameters to be used. You can either specify an</span>
<span class="sd">    *analysis_yaml* file containing information about a pRF-analysis, or specify *settings=&#39;recent&#39;* to fetch the most recent</span>
<span class="sd">    analysis file in the pRF-directory of the subject. The latter is generally fine if you want information about the stimulus.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subject: str</span>
<span class="sd">        subject ID as used throughout the pipeline</span>
<span class="sd">    ses: int, optional</span>
<span class="sd">        Source session of pRF-parameters to use, by default 1</span>
<span class="sd">    derivatives: str, optional</span>
<span class="sd">        Derivatives directory, by default None. </span>
<span class="sd">    cx_dir: str, optional</span>
<span class="sd">        path to subject-specific pycortex directory</span>
<span class="sd">    prf_dir: str, optional</span>
<span class="sd">        subject-specific pRF directory, by default None. `derivatives` will be ignore if this flag is used</span>
<span class="sd">    hemi: str, optional</span>
<span class="sd">        Hemisphere to extract target vertex from, by default &quot;lh&quot;</span>
<span class="sd">    model: str, optional</span>
<span class="sd">        By default `gauss`, which reads in the gaussian iterative fit parameters in a </span>
<span class="sd">        :class:`fmriproc.prf.pRFmodelFitting`-object. Can be any of the allowed models (&#39;gauss&#39;, &#39;css&#39;, &#39;dog&#39;, norm).</span>
<span class="sd">    verbose: bool, optional</span>
<span class="sd">        Set to True if you want some messages along the way (default = True)</span>
<span class="sd">    resize_pix: int</span>
<span class="sd">        resolution of pRF to resample to. For instance, if you&#39;ve used a low-resolution design matrix, but you&#39;d like a</span>
<span class="sd">        prettier image, you can set `resize` to something higher than the original (54 &gt;&gt; 270, for example). By default not</span>
<span class="sd">        used.</span>
<span class="sd">    best_vertex: bool, optional</span>
<span class="sd">        Signifies that we should load in the parameters of the target vertex used in line-scanning experiments. If *True*, the</span>
<span class="sd">        &#39;best_vertex&#39;-parameters given `model` will be read in. If *False*, the iterative fit parameters from `model` will be</span>
<span class="sd">        read in.</span>
<span class="sd">    filter_list: list, optional</span>
<span class="sd">        Extra filters to search for particular design matrix. By default, we&#39;ll look for a file with [&quot;design&quot;, &quot;mat&quot;], but if</span>
<span class="sd">        you have multiple files that correspond to this list you can add extra elements to pick the file you need, e.g.,</span>
<span class="sd">        `filter_list=[&quot;acq-3DEPI&quot;]`</span>

<span class="sd">    Example</span>
<span class="sd">    ----------</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">    </span>
<span class="sd">        from lazyfmri import utils</span>
<span class="sd">        subject_info = utils.CollectSubject(subject, derivatives=&lt;path_to_derivatives&gt;, settings=&#39;recent&#39;, hemi=&quot;lh&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">subject</span><span class="p">,</span> 
        <span class="n">ses</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">derivatives</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">cx_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">prf_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;lh&quot;</span><span class="p">,</span> 
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> 
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">best_vertex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">filter_list</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">fit_hrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">v1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span>        <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span>    <span class="o">=</span> <span class="n">derivatives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span>         <span class="o">=</span> <span class="n">cx_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span>        <span class="o">=</span> <span class="n">prf_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prf_ses</span>        <span class="o">=</span> <span class="n">ses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span>           <span class="o">=</span> <span class="n">hemi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span>          <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>        <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_vertex</span>    <span class="o">=</span> <span class="n">best_vertex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_list</span>    <span class="o">=</span> <span class="n">filter_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span>        <span class="o">=</span> <span class="n">fit_hrf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v1_data</span>        <span class="o">=</span> <span class="n">v1</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lh&quot;</span><span class="p">,</span><span class="s2">&quot;l&quot;</span><span class="p">,</span><span class="s2">&quot;left&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi_tag</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rh&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi_tag</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi_tag</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span>

        <span class="c1"># set pRF directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">derivatives</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">,</span> <span class="s1">&#39;prf&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ses-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_ses</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
        <span class="c1"># get design matrix, vertex info, and analysis file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">design_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">([</span><span class="s2">&quot;design&quot;</span><span class="p">,</span> <span class="s2">&quot;.mat&quot;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span><span class="p">)</span>

            <span class="c1"># error message in case multiple files are found</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_fn</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found multiple files matching the criteria: [&#39;design&#39;, &#39;mat&#39;]; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">design_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_fn</span><span class="p">)</span> <span class="c1"># read_par_file doesn&#39;t care whether it&#39;s a npy-/mat-/pkl-file</span>

            <span class="n">search_for</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;avg_bold&quot;</span><span class="p">,</span> <span class="s2">&quot;.npy&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v1_data</span><span class="p">:</span>
                <span class="n">search_for</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;_roi-V1&quot;</span><span class="p">]</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="s2">&quot;_roi-V1&quot;</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;_lr&quot;</span><span class="p">,</span><span class="s2">&quot;_l&quot;</span><span class="p">,</span><span class="s2">&quot;_r&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;hemi-LR_&quot;</span><span class="p">,</span><span class="s2">&quot;hemi-L_&quot;</span><span class="p">,</span><span class="s2">&quot;hemi-R_&quot;</span><span class="p">]):</span>

                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span>
                        <span class="n">search_for</span><span class="o">+</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span><span class="p">,</span> 
                        <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">))</span>
                    
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;func_data</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    
            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">func_data_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">([</span><span class="s2">&quot;desc-data.npy&quot;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: could not load all functional data from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># try to read iterative fit parameters</span>
        <span class="n">allowed_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="s1">&#39;abd&#39;</span><span class="p">]</span>
        <span class="n">look_for</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stage-iter&quot;</span><span class="p">,</span> <span class="s2">&quot;params.pkl&quot;</span><span class="p">]</span>
        
        <span class="c1"># add some filters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v1_data</span><span class="p">:</span>
            <span class="n">look_for</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;_roi-V1&quot;</span><span class="p">]</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="s2">&quot;_roi-V1&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_hrf</span><span class="p">:</span>
            <span class="n">look_for</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;hrf-true_&quot;</span><span class="p">]</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading full-cortex pRF estimates with </span><span class="si">{</span><span class="n">look_for</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">allowed_models</span><span class="p">:</span>
            <span class="n">par_file</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">(</span>
                <span class="n">look_for</span><span class="o">+</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;model-</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prf_dir</span><span class="p">,</span>
                <span class="n">return_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">par_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars_file&#39;</span><span class="p">,</span> <span class="n">par_file</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars&#39;</span><span class="p">,</span> <span class="n">read_par_file</span><span class="p">(</span><span class="n">par_file</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars_df&#39;</span><span class="p">,</span>
                    <span class="n">Parameters</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars&#39;</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars_arr&#39;</span><span class="p">,</span>
                    <span class="n">Parameters</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars_df&#39;</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
                <span class="p">)</span>
        
        <span class="c1"># set pycortex directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">derivatives</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derivatives</span><span class="p">,</span> <span class="s1">&#39;pycortex&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vert_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;best_vertices.csv&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span><span class="p">,</span> <span class="n">return_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vert_fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vert_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vert_info</span> <span class="o">=</span> <span class="n">VertexInfo</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vert_fn</span><span class="p">,</span> 
                    <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> 
                    <span class="n">hemi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">)</span>
        
        <span class="c1"># fetch target vertex parameters</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;vert_info&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_vertex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_target_vertex</span><span class="p">(</span><span class="n">hemi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target vertex: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_vertex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">target_params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">_iter_pars_arr&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_vertex</span><span class="p">,:]</span>

        <span class="c1"># find the csv file with parameters (generally available with &#39;norm&#39;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_vertex</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_fn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_from_substring</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;model-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;desc-params.csv&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cx_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalization_params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_fn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_params_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_params</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            
            <span class="n">tmp_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;func_data_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi_tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tmp_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target_vertex</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;target vertex&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_iter_pars&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_iter_pars&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not find &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">_iter_pars&#39; attribute&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;func_data_lr&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_data_lr</span><span class="o">.</span><span class="n">T</span>

            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;full cortex&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape final parameters: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># initialize the model</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">design_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">design_matrix</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pars&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_params</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> 
                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
                    <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;iter&quot;</span><span class="p">,</span> 
                    <span class="n">hemi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi_tag</span><span class="p">,</span>
                    <span class="n">skip_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_settings</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: could not initiate model due to missing data. Some functions may not work.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CollectSubject.return_prf_params">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.CollectSubject.return_prf_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_prf_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;lh&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return pRF parameters from :class:`fmriproc.prf.VertexInfo`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prf&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">)</span></div>


<div class="viewcode-block" id="CollectSubject.return_target_vertex">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.CollectSubject.return_target_vertex">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_target_vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;lh&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return the vertex ID of target vertex&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="n">hemi</span><span class="p">)</span></div>


<div class="viewcode-block" id="CollectSubject.target_prediction_prf">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.CollectSubject.target_prediction_prf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">target_prediction_prf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xkcd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">freq_spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_figure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">targ_pars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_prf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_tc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_vox</span><span class="p">(</span>
            <span class="n">vox_nr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
            <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> 
            <span class="n">make_figure</span><span class="o">=</span><span class="n">make_figure</span><span class="p">,</span> 
            <span class="n">xkcd</span><span class="o">=</span><span class="n">xkcd</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;pars&#39;</span><span class="p">,</span>
            <span class="n">freq_spectrum</span><span class="o">=</span><span class="n">freq_spectrum</span><span class="p">,</span> 
            <span class="n">freq_type</span><span class="o">=</span><span class="s2">&quot;fft&quot;</span><span class="p">,</span>
            <span class="n">save_as</span><span class="o">=</span><span class="n">save_as</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;pars&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_pars</span><span class="p">,</span>
            <span class="s2">&quot;prf&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_prf</span><span class="p">,</span>
            <span class="s2">&quot;tc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_tc</span><span class="p">,</span>
            <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ_pred</span><span class="p">}</span></div>
</div>


<div class="viewcode-block" id="baseline_from_dm">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.baseline_from_dm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">baseline_from_dm</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">n_trs</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">shifted_dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span>
    <span class="n">shifted_dm</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">n_trs</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="n">n_trs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shifted_dm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Parameters">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Parameters">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Parameters</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span><span class="s2">&quot;dog&quot;</span><span class="p">,</span><span class="s2">&quot;css&quot;</span><span class="p">,</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="s1">&#39;abc&#39;</span><span class="p">,</span><span class="s1">&#39;abd&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">read_par_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            
<div class="viewcode-block" id="Parameters.to_df">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Parameters.to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input must be np.ndarray, not &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>

        <span class="c1"># see: https://github.com/VU-Cog-Sci/prfpy_tools/blob/master/utils/postproc_utils.py#L377</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s2">&quot;prf_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;prf_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;bold_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;ecc&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;polar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
                    
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s2">&quot;prf_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;prf_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;bold_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s2">&quot;surr_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span>
                    <span class="s2">&quot;surr_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">],</span> 
                    <span class="s2">&quot;neur_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">7</span><span class="p">],</span>
                    <span class="s2">&quot;surr_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">8</span><span class="p">],</span>
                    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> 
                    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">7</span><span class="p">],</span> <span class="c1">#/params[:,3], </span>
                    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> 
                    <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">8</span><span class="p">],</span>
                    <span class="s2">&quot;ratio (B/D)&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">8</span><span class="p">],</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;size ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;suppression index&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;ecc&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;polar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)}</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_dsip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s2">&quot;prf_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;prf_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;bold_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s2">&quot;surr_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span>
                    <span class="s2">&quot;surr_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">],</span> 
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;size ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;suppression index&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;ecc&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;polar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)}</span>

                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_dsip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
                <span class="n">params_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="s2">&quot;prf_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s2">&quot;prf_ampl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;bold_bsl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s2">&quot;css_exp&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;ecc&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;polar&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)}</span>     
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">params_dict</span><span class="p">[</span><span class="s2">&quot;hrf_dsip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[:,</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_models</span><span class="si">}</span><span class="s2">. Not &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">params_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.to_array">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Parameters.to_array">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input must be pd.DataFrame, not &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;prf_size&quot;</span><span class="p">,</span><span class="s2">&quot;prf_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;bold_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">,</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;prf_size&quot;</span><span class="p">,</span><span class="s2">&quot;prf_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;bold_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;surr_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;surr_size&quot;</span><span class="p">,</span><span class="s2">&quot;neur_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;surr_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">,</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;dog&quot;</span><span class="p">:</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;prf_size&quot;</span><span class="p">,</span><span class="s2">&quot;prf_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;bold_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;surr_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;surr_size&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">,</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;css&quot;</span><span class="p">:</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;prf_size&quot;</span><span class="p">,</span><span class="s2">&quot;prf_ampl&quot;</span><span class="p">,</span><span class="s2">&quot;bold_bsl&quot;</span><span class="p">,</span><span class="s2">&quot;css_exp&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_deriv&quot;</span><span class="p">,</span><span class="s2">&quot;hrf_disp&quot;</span><span class="p">,</span><span class="s2">&quot;r2&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model must be one of &#39;gauss&#39;,&#39;norm&#39;,&#39;dog&#39;,&#39;css&#39;; not &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parr</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># parallel counter in case HRF-parameters are not present</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">item_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
                    <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="create_model_rf_wrapper">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.create_model_rf_wrapper">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_model_rf_wrapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">stim</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">normalize_RFs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">prf</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">gauss2D_iso_cart</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">x_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">y_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="n">mu</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">normalize_RFs</span><span class="o">=</span><span class="n">normalize_RFs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;css&#39;</span><span class="p">:</span>
        <span class="n">prf</span> <span class="o">**=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;dog&#39;</span><span class="p">:</span>
        <span class="n">prf</span> <span class="o">-=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">gauss2D_iso_cart</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">x_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">y_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                <span class="n">mu</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">normalize_RFs</span><span class="o">=</span><span class="n">normalize_RFs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="s2">&quot;abd&quot;</span><span class="p">]:</span>
        <span class="n">prf</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">prf</span> <span class="o">/=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">gauss2D_iso_cart</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">x_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">y_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                <span class="n">mu</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">normalize_RFs</span><span class="o">=</span><span class="n">normalize_RFs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

        <span class="n">prf</span> <span class="o">-=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="mi">8</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">prf</span></div>


<div class="viewcode-block" id="FormatTimeCourses">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.FormatTimeCourses">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FormatTimeCourses</span><span class="p">():</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">data</span><span class="p">,</span> 
        <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>

        <span class="c1"># format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatted_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_verts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_hemi_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    
<div class="viewcode-block" id="FormatTimeCourses.return_data">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.FormatTimeCourses.return_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatted_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="FormatTimeCourses.average_iterations">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.FormatTimeCourses.average_iterations">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">average_iterations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">data</span><span class="p">,</span> 
        <span class="n">n_folds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;folds-argument must be integer, not </span><span class="si">{</span><span class="n">n_folds</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">n_folds</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">n_vols</span><span class="p">,</span><span class="n">n_vertices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">iter_size</span> <span class="o">=</span> <span class="n">n_vols</span><span class="o">//</span><span class="n">n_folds</span>
        
        <span class="n">chunk_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_folds</span><span class="p">):</span>

            <span class="c1"># try to fetch values, if steps are out of bounds, zero-pad the timecourse</span>
            <span class="n">end_point</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">iter_size</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chunk #</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_point</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_point</span> <span class="o">&lt;=</span> <span class="n">n_vols</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end_point</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data with </span><span class="si">{</span><span class="n">n_vertices</span><span class="si">}</span><span class="s2"> vertices cannot be split evenly in chunks of </span><span class="si">{</span><span class="n">iter_size</span><span class="si">}</span><span class="s2">. Use &#39;--cut_vols &lt;n_vols&gt;&#39; to remove volumes at the beginning to align the data&quot;</span><span class="p">)</span>

            <span class="n">chunk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">iter_size</span>

        <span class="n">chunked_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunked_array</span></div>


<div class="viewcode-block" id="FormatTimeCourses.get_verts">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.FormatTimeCourses.get_verts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_verts</span></div>

    
<div class="viewcode-block" id="FormatTimeCourses.format_hemi_data">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.FormatTimeCourses.format_hemi_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_hemi_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pair</span><span class="p">,</span>
        <span class="n">gifti</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">psc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">n_folds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>

        <span class="c1"># different function for giftis</span>
        <span class="k">if</span> <span class="n">gifti</span><span class="p">:</span>
            <span class="n">hemi_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">ParseGiftiFile</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hemi_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">))]</span>

        <span class="n">n_verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">hemi_data</span><span class="p">]</span>

        <span class="c1"># stack into array (time,voxels)</span>
        <span class="n">hemi_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">hemi_data</span><span class="p">)</span>

        <span class="c1"># cut vols?</span>
        <span class="k">if</span> <span class="s2">&quot;cut_vols&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># print(f&quot;cutting {kwargs[&#39;cut_vols&#39;]} away&quot;)</span>
            <span class="n">hemi_data</span> <span class="o">=</span> <span class="n">hemi_data</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;cut_vols&quot;</span><span class="p">]:,:]</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cut_vols&quot;</span><span class="p">)</span>

        <span class="c1"># check if we got multiple repeats within runs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">hemi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_iterations</span><span class="p">(</span>
                <span class="n">hemi_data</span><span class="p">,</span> 
                <span class="n">n_folds</span><span class="o">=</span><span class="n">n_folds</span><span class="p">,</span> 
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="c1"># do percent change following marco&#39;s method</span>
        <span class="k">if</span> <span class="n">psc</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">dict</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify a path representing the design matrix, or a numpy array, not </span><span class="si">{</span><span class="n">dm</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">hemi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hemi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(f&quot;cutting {diff} from design&quot;)</span>
                <span class="n">dm</span> <span class="o">=</span> <span class="n">dm</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">diff</span><span class="p">:]</span>

            <span class="n">hemi_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">percent_change</span><span class="p">(</span>
                <span class="n">hemi_data</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">prf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dm</span><span class="o">=</span><span class="n">dm</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">hemi_data</span><span class="p">,</span><span class="n">n_verts</span></div>
</div>


<div class="viewcode-block" id="Profile1D">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Profile1D">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Profile1D</span><span class="p">(</span><span class="n">pRFmodelFitting</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pars</span><span class="p">,</span>
        <span class="n">n_pix</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">plot_kws</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">metrics_kws</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">dm_kws</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span>
        <span class="n">first_cross</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">pars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span> <span class="o">=</span> <span class="n">n_pix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_kws</span> <span class="o">=</span> <span class="n">plot_kws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_kws</span> <span class="o">=</span> <span class="n">metrics_kws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dm_kws</span> <span class="o">=</span> <span class="n">dm_kws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_cross</span> <span class="o">=</span> <span class="n">first_cross</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_dm</span><span class="p">(</span>
            <span class="n">n_pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
            <span class="n">pars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">dm_kws</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">design_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span>
            <span class="n">TR</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">hrf</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># skip plot by default</span>
        <span class="n">ddict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;make_figure&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;axis_type&quot;</span><span class="p">:</span> <span class="s2">&quot;volumes&quot;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">ddict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plot_kws</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_kwargs</span><span class="p">(</span>
                <span class="n">plot_kws</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">val</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prf_o</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_vox</span><span class="p">(</span>
            <span class="n">vox_nr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> 
            <span class="n">resize_pix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span>
            <span class="o">**</span><span class="n">plot_kws</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prof_1d</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">Epoch</span><span class="o">.</span><span class="n">correct_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_1d</span><span class="p">,</span> <span class="n">bsl</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># find fwhm in pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">HRFMetrics</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prof_1d</span><span class="p">,</span> 
            <span class="n">TR</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_kws</span>
        <span class="p">)</span><span class="o">.</span><span class="n">return_metrics</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fwhm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fwhm_deg</span> <span class="o">=</span> <span class="n">pix2deg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span><span class="p">,</span>
            <span class="n">scrSizePix</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">),</span>
            <span class="n">scrWidthCm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;screen_size_cm&quot;</span><span class="p">],</span>
            <span class="n">scrDist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;screen_distance_cm&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># try to find zero crossings</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_cross</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_crossings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_1d</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find zero-crossings of 1d profile..&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;zero_cross&quot;</span><span class="p">):</span>

            <span class="c1"># sometimes the outer borders of the image are counted as crossing; this flag dictates to only take the first crossings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_cross_pix</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_cross</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_cross</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_cross_pix</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">zero_cross_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_cross_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_cross_pix</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_deg</span> <span class="o">=</span> <span class="n">pix2deg</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zero_diff</span><span class="p">,</span>
                <span class="n">scrSizePix</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pix</span><span class="p">),</span>
                <span class="n">scrWidthCm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;screen_size_cm&quot;</span><span class="p">],</span>
                <span class="n">scrDist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;screen_distance_cm&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            
<div class="viewcode-block" id="Profile1D.create_dm">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Profile1D.create_dm">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_dm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">n_pix</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>

        <span class="c1"># create impulse design matrix (single pixel traversing left-to-right)</span>
        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">y_pos</span> <span class="o">=</span> <span class="n">n_pix</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">deg2pix</span><span class="p">(</span>
                <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">scrSizePix</span><span class="o">=</span><span class="p">[</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">],</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">))</span>

            <span class="n">y_pos</span> <span class="o">+=</span> <span class="n">n_pix</span><span class="o">//</span><span class="mi">2</span>
            <span class="c1"># raise NotImplementedError(f&quot;Still need to implement translating a position in DVA to pixel&quot;)</span>

        <span class="n">tiny_dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">,</span><span class="n">n_pix</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiny_dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">tiny_dm</span><span class="p">[</span><span class="n">y_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">tiny_dm</span></div>


<div class="viewcode-block" id="Profile1D.plot_dm">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Profile1D.plot_dm">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_dm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;interval&quot;</span><span class="p">,</span><span class="s2">&quot;n_cols&quot;</span><span class="p">,</span><span class="s2">&quot;figsize&quot;</span><span class="p">],[</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">)]):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">update_kwargs</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">val</span>
            <span class="p">)</span>

        <span class="n">plot_stims</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Profile1D.find_crossings">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.Profile1D.find_crossings">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_crossings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curve</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">find_intersection</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">curve</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
            <span class="n">curve</span><span class="p">,</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">curve</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="VertexInfo">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.VertexInfo">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VertexInfo</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; VertexInfo</span>
<span class="sd">    </span>
<span class="sd">    This object reads a .csv file containing relevant information about the angles, vertex position, and normal vector.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infofile: str</span>
<span class="sd">        path to the information file containing `best_vertices` in the filename</span>
<span class="sd">    subject: str</span>
<span class="sd">        subject ID as used in `SUBJECTS_DIR`</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    attr</span>
<span class="sd">        sets attributes in the class    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;lh&quot;</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">infofile</span> <span class="o">=</span> <span class="n">infofile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infofile</span><span class="p">)</span>
        
        <span class="c1"># try to set the index to hemi. It will throw an error if you want to set the index while there already is an index.</span>
        <span class="c1"># E.g., initially we will set the index to &#39;hemi&#39;. If we then later on read in that file again, the index is already </span>
        <span class="c1"># set</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;hemi&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            
        <span class="k">if</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;lh&quot;</span><span class="p">,</span><span class="s2">&quot;l&quot;</span><span class="p">,</span><span class="s2">&quot;left&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span>
        <span class="k">elif</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rh&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hemi</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="c1"># check if arrays are in string format</span>
            <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">]</span>   <span class="o">=</span> <span class="n">string2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">]</span> <span class="o">=</span> <span class="n">string2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="n">hemi</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">]</span>   <span class="o">=</span> <span class="n">string2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">]</span> <span class="o">=</span> <span class="n">string2float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">hemi</span><span class="p">])</span>            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>

<div class="viewcode-block" id="VertexInfo.get">
<a class="viewcode-back" href="../../classes/prf.html#fmriproc.prf.VertexInfo.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">hemi</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;return values from dataframe given keyword. Can be any column name or &#39;prf&#39; for pRF-parameters&quot;&quot;&quot;</span>

        <span class="n">keywords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;prf&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;lh&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">]],</span>
                    <span class="s2">&quot;rh&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">]]}</span>
            <span class="k">elif</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rh&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lh&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;r2&#39;</span><span class="p">]]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="n">keywords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;lh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">],</span>
                        <span class="s2">&quot;rh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rh&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span> <span class="ow">or</span> <span class="n">hemi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lh&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">keyword</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">]</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>